<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte de Prospection - Mansion Bordeaux</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    /* --- RESET & BASE --- */
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; color: #333; overflow: hidden; }
    * { box-sizing: border-box; }

    /* --- LAYOUT --- */
    header {
      background: #fff; padding: 10px 15px; border-bottom: 1px solid #ddd;
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; z-index: 1000; position: relative;
    }
    .brand { font-weight: 700; font-size: 15px; }
    
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    select, button { font-size: 13px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #000; color: #fff; border: 1px solid #000; }
    button.accent { background: #0066cc; color: #fff; border: none; }
    
    /* --- DASHBOARD --- */
    #dashboard {
      background: #fff; border-bottom: 1px solid #ddd; padding: 10px 15px;
      max-height: 30vh; overflow-y: auto; font-size: 13px; display: flex; flex-direction: column; gap: 8px;
    }
    .stats-row { display: flex; gap: 15px; flex-wrap: wrap; color: #555; font-size: 12px; align-items: center; }
    
    .tour-panel { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
    .input-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 120px; }
    .input-group label { font-size: 11px; font-weight: 600; color: #666; }
    .input-group input, .input-group textarea { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }

    /* --- CARTE --- */
    #map { width: 100%; height: calc(100vh - 180px); background: #e5e5e5; }
    
    /* --- LOADERS --- */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; padding: 20px;
    }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #statusMessage { color: green; font-weight: 600; font-size: 12px; margin-left: 10px; opacity: 0; transition: opacity 0.5s; }
    
    /* --- POPUP & CUSTOM --- */
    .leaflet-popup-content { font-size: 13px; line-height: 1.4; text-align: center; }
    .popup-btn { width: 100%; margin-top: 8px; padding: 8px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
    
    /* Style pour masquer les rues hors-secteur tout en les gardant affich√©es l√©g√®rement */
    .dimmed-street { opacity: 0.3 !important; stroke-dasharray: 5, 5; }

  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">Initialisation...</div>
  </div>

  <header>
    <div class="brand">Mansion Bordeaux <span style="font-weight:400; color:#666;">| Prospection</span></div>
    <div class="controls">
      <select id="negociateurSelect">
        <option value="Alexis">Alexis (Nord-Ouest)</option>
        <option value="Nicolas">Nicolas (Nord-Est)</option>
        <option value="Thibault">Thibault (Sud-Ouest)</option>
        <option value="Laurent">Laurent (Sud-Est)</option>
      </select>
      <button id="gpsBtn" class="accent">üìç GPS</button>
      <button id="refreshBtn">üîÑ Recharger Rues</button>
    </div>
  </header>

  <div id="dashboard">
    <div class="stats-row">
      <span class="stat-item">Tourn√©e : <strong id="timerDisplay">00:00:00</strong></span>
      <span class="stat-item">Couverture : <strong id="coverageDisplay">--%</strong></span>
      <span id="statusMessage"></span>
    </div>

    <div class="tour-panel">
      <div class="input-group">
        <label>Flyers</label>
        <input type="number" id="flyersInput" placeholder="Qt√©" />
      </div>
      <div class="input-group" style="flex: 2;">
        <label>Rapport / Notes</label>
        <textarea id="reportInput" placeholder="R.A.S..."></textarea>
      </div>
      <div style="display:flex; flex-direction:column; gap:5px; margin-top: auto;">
        <button id="toggleTourBtn" class="primary">‚ñ∂ D√©marrer</button>
        <button id="saveTourBtn" style="background:#eee; color:#333;" disabled>üíæ Finir</button>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    /* =========================================
       1. CONFIGURATION
       ========================================= */
    
    const SUPABASE_URL = "https://wqujtckrvdhrwknplumq.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";

    let supabaseClient = null;
    if (typeof supabase !== "undefined") {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // ZONES MISES √Ä JOUR (Saint-Andr√©-de-Cubzac approximatif)
    // Les polygones se rejoignent au centre ville (D1010 / Rue Nationale)
    const ZONES = [
      {
        id: 1, negociateur: "Alexis", color: "#e74c3c", // NORD OUEST
        poly: [[-0.48, 45.02], [-0.446, 45.02], [-0.446, 44.994], [-0.48, 44.994]] 
      },
      {
        id: 2, negociateur: "Nicolas", color: "#3498db", // NORD EST
        poly: [[-0.446, 45.02], [-0.41, 45.02], [-0.41, 44.994], [-0.446, 44.994]]
      },
      {
        id: 3, negociateur: "Thibault", color: "#f1c40f", // SUD OUEST
        poly: [[-0.48, 44.994], [-0.446, 44.994], [-0.446, 44.96], [-0.48, 44.96]]
      },
      {
        id: 4, negociateur: "Laurent", color: "#9b59b6", // SUD EST
        poly: [[-0.446, 44.994], [-0.41, 44.994], [-0.41, 44.96], [-0.446, 44.96]]
      }
    ];
    
    const state = {
      negociateur: "Alexis",
      streets: {}, // Stocke les objets { layer, zoneId, lastPassage, name }
      tourRunning: false,
      startTime: null,
      timerInterval: null,
      gpsWatch: null,
      userMarker: null
    };

    const ui = {
      loader: document.getElementById('loadingOverlay'),
      loadText: document.getElementById('loadingText'),
      negociateurSelect: document.getElementById('negociateurSelect'),
      flyers: document.getElementById('flyersInput'),
      report: document.getElementById('reportInput'),
      toggleBtn: document.getElementById('toggleTourBtn'),
      saveBtn: document.getElementById('saveTourBtn'),
      timer: document.getElementById('timerDisplay'),
      coverage: document.getElementById('coverageDisplay'),
      status: document.getElementById('statusMessage'),
      gpsBtn: document.getElementById('gpsBtn'),
      refreshBtn: document.getElementById('refreshBtn')
    };

    // Centr√© sur Saint-Andr√©-de-Cubzac
    const map = L.map('map', { zoomControl: false }).setView([44.994, -0.446], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap',
      maxZoom: 19
    }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    /* =========================================
       2. CHARGEMENT DES DONN√âES (OVERPASS API)
       ========================================= */

    async function fetchStreetsFromOverpass(bbox) {
        // Bbox format: [south, west, north, east]
        // Requete API pour avoir les rues r√©sidentielles uniquement (pas les autoroutes)
        const query = `
            [out:json][timeout:25];
            (
              way["highway"~"residential|living_street|unclassified|service"](${bbox});
            );
            out geom;
        `;
        const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            return data.elements;
        } catch (error) {
            console.error("Erreur Overpass:", error);
            alert("Impossible de charger les rues (API Overpass satur√©e). R√©essayez dans quelques secondes.");
            return [];
        }
    }

    function getStreetColor(lastPassageDate) {
      if (!lastPassageDate) return "#bdc3c7"; // Gris clair par d√©faut (non fait)
      const diffTime = Math.abs(new Date() - new Date(lastPassageDate));
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
      if (diffDays <= 20) return "#2ecc71"; // Vert
      if (diffDays <= 45) return "#f39c12"; // Orange
      return "#e74c3c"; // Rouge
    }

    async function initApp() {
      ui.loadText.textContent = "Connexion Base de Donn√©es...";
      
      // 1. R√©cup√©rer l'historique existant
      let historyMap = {};
      if (supabaseClient) {
        const { data } = await supabaseClient
          .from('street_passages')
          .select('street_name, passage_date, negociateur');
        if (data) {
          data.forEach(row => {
            historyMap[row.street_name] = { date: row.passage_date, nego: row.negociateur };
          });
        }
      }

      // 2. D√©finir la zone de t√©l√©chargement (autour de St Andr√©)
      // Sud, Ouest, Nord, Est
      const bbox = "44.97, -0.48, 45.02, -0.41"; 
      
      ui.loadText.textContent = "T√©l√©chargement des rues (OpenStreetMap)...";
      const streetElements = await fetchStreetsFromOverpass(bbox);
      
      ui.loadText.textContent = "Construction de la carte...";
      
      // 3. Dessiner les rues
      state.streets = {}; // Reset
      
      streetElements.forEach(el => {
        if (!el.tags || !el.tags.name) return; // On ignore les rues sans nom
        const name = el.tags.name;
        
        // Conversion coords Overpass -> Leaflet
        const latlngs = el.geometry.map(pt => [pt.lat, pt.lon]);
        
        // Calcul Zone (Turf.js)
        // On prend le milieu de la rue pour d√©terminer la zone
        const centerPt = latlngs[Math.floor(latlngs.length / 2)];
        const turfPt = turf.point([centerPt[1], centerPt[0]]); // [Lon, Lat]
        
        let zoneId = null;
        for (let z of ZONES) {
          const polyGeoJSON = turf.polygon([z.poly]);
          if (turf.booleanPointInPolygon(turfPt, polyGeoJSON)) {
            zoneId = z.id;
            break;
          }
        }

        // Si la rue existe d√©j√† (plusieurs segments), on fusionne ou on ignore
        // Ici simple : on ajoute chaque segment
        const hist = historyMap[name] || { date: null, nego: null };
        const color = getStreetColor(hist.date);

        // -- A. Couche Clic (Invisible, √âpaisse) --
        L.polyline(latlngs, { weight: 25, opacity: 0 }).addTo(map)
           .on('click', (e) => openStreetPopup(e, name, zoneId));

        // -- B. Couche Visuelle (Fine) --
        const visualLine = L.polyline(latlngs, { 
            color: color, 
            weight: 3, // TRAIT PLUS FIN
            opacity: 0.9, 
            interactive: false // Le clic passe au travers
        }).addTo(map);

        // On stocke dans l'√©tat (Attention: pour les rues √† plusieurs segments, on stocke un tableau ou on √©crase. 
        // Pour simplifier ici on stocke le dernier segment comme r√©f√©rence de style, mais id√©alement il faut un groupe).
        if (!state.streets[name]) {
             state.streets[name] = { layers: [], zoneId: zoneId, lastPassage: hist.date, lastNego: hist.nego };
        }
        state.streets[name].layers.push(visualLine);
      });

      // 4. Dessiner les zones (Contours discrets)
      ZONES.forEach(z => {
        const leafPoly = z.poly.map(p => [p[1], p[0]]);
        L.polygon(leafPoly, { 
          color: z.color, fill: true, fillOpacity: 0.03, weight: 1, dashArray: '4, 8', interactive: false 
        }).addTo(map);
        
        // Label de zone
        const center = L.polygon(leafPoly).getBounds().getCenter();
        L.marker(center, { 
            icon: L.divIcon({ 
                className: 'zone-label', 
                html: `<div style="color:${z.color}; font-weight:bold; font-size:10px;">${z.negociateur}</div>`,
                iconSize: [100, 20]
            }) 
        }).addTo(map);
      });

      updateInterface();
      ui.loader.style.display = 'none';
    }

    /* =========================================
       3. INTERACTION & LOGIQUE
       ========================================= */

    function openStreetPopup(e, name, zoneId) {
      const st = state.streets[name];
      const dateStr = st.lastPassage ? new Date(st.lastPassage).toLocaleDateString() : "Jamais";
      const safeName = name.replace(/'/g, "\\'");
      
      const content = `
        <div style="min-width:160px">
          <strong>${name}</strong><br>
          <small style="color:#888">${zoneId ? "Secteur " + zoneId : "Hors Zone"}</small>
          <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
          Dernier: <b>${dateStr}</b><br>
          <button class="popup-btn" onclick="markStreetAsDone('${safeName}')">‚úÖ FAIT AUJOURD'HUI</button>
        </div>
      `;
      L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
    }

    window.markStreetAsDone = async function(name) {
      const today = new Date().toISOString().split('T')[0];
      const st = state.streets[name];

      if (st) {
        // Mise √† jour de tous les segments de la rue
        st.layers.forEach(layer => layer.setStyle({ color: '#2ecc71' }));
        st.lastPassage = today;
        st.lastNego = state.negociateur;
      }
      map.closePopup();
      updateCoverage();

      if (supabaseClient) {
        await supabaseClient.from('street_passages').upsert({ 
            street_name: name, 
            passage_date: today, 
            negociateur: state.negociateur,
            zone_id: st.zoneId
        }, { onConflict: 'street_name' }); // On √©crase l'ancienne date si existe
      }
    };

    function updateInterface() {
      const currentZoneObj = ZONES.find(z => z.negociateur === state.negociateur);
      const currentZoneId = currentZoneObj ? currentZoneObj.id : null;

      Object.values(state.streets).forEach(st => {
        const isMyZone = (st.zoneId === currentZoneId);
        
        st.layers.forEach(layer => {
            if (isMyZone) {
                // Secteur actif : pleine couleur
                layer.setStyle({ opacity: 1, dashArray: null, weight: 3 });
            } else {
                // Autres secteurs : discret
                layer.setStyle({ opacity: 0.3, dashArray: '5, 10', weight: 2 });
            }
        });
      });
      updateCoverage();
    }

    function updateCoverage() {
      const currentZoneId = ZONES.find(z => z.negociateur === state.negociateur)?.id;
      // On compte les rues UNIQUES du secteur
      const streetsInZone = Object.values(state.streets).filter(s => s.zoneId === currentZoneId);
      
      if (streetsInZone.length === 0) { ui.coverage.innerText = "N/A"; return; }

      const now = new Date();
      const doneCount = streetsInZone.filter(s => {
        if (!s.lastPassage) return false;
        const diff = (now - new Date(s.lastPassage)) / (1000 * 3600 * 24);
        return diff <= 20;
      }).length;

      const pct = Math.round((doneCount / streetsInZone.length) * 100);
      ui.coverage.innerText = `${pct}% (${doneCount}/${streetsInZone.length})`;
    }

    // --- BOUTONS & GPS (Standard) ---
    ui.negociateurSelect.addEventListener('change', (e) => {
        state.negociateur = e.target.value;
        updateInterface();
    });
    
    ui.refreshBtn.addEventListener('click', () => {
        if(confirm("Recharger les rues consomme de la donn√©e. Continuer ?")) initApp();
    });

    ui.toggleBtn.addEventListener('click', () => {
       state.tourRunning = !state.tourRunning;
       if(state.tourRunning) {
           state.startTime = Date.now();
           ui.toggleBtn.textContent = "‚è∏ Pause"; ui.toggleBtn.classList.replace('primary','accent');
           ui.saveBtn.disabled = true;
           state.timerInterval = setInterval(() => {
               const d = Math.floor((Date.now()-state.startTime)/1000);
               ui.timer.innerText = new Date(d*1000).toISOString().substr(11,8);
           }, 1000);
       } else {
           clearInterval(state.timerInterval);
           ui.toggleBtn.textContent = "‚ñ∂ Reprendre"; ui.toggleBtn.classList.replace('accent','primary');
           ui.saveBtn.disabled = false;
       }
    });

    ui.saveBtn.addEventListener('click', async () => {
        if(!supabaseClient) return alert("Pas de connexion BDD");
        const { error } = await supabaseClient.from('tours').insert({
            negociateur: state.negociateur,
            date: new Date().toISOString().split('T')[0],
            flyers: ui.flyers.value,
            report: ui.report.value,
            duration_sec: Math.floor((Date.now() - state.startTime)/1000)
        });
        if(!error) { alert("Tourn√©e sauvegard√©e !"); location.reload(); }
    });

    ui.gpsBtn.addEventListener('click', () => {
        if (state.gpsWatch) {
            navigator.geolocation.clearWatch(state.gpsWatch); state.gpsWatch=null;
            if(state.userMarker) map.removeLayer(state.userMarker);
            ui.gpsBtn.textContent = "üìç GPS";
        } else {
            state.gpsWatch = navigator.geolocation.watchPosition(pos => {
                const ll = [pos.coords.latitude, pos.coords.longitude];
                if(!state.userMarker) state.userMarker = L.circleMarker(ll, {radius:8, color:'white', fillColor:'#007AFF', fillOpacity:1}).addTo(map);
                else state.userMarker.setLatLng(ll);
                map.setView(ll);
            }, null, {enableHighAccuracy:true});
            ui.gpsBtn.textContent = "Arr√™ter GPS";
        }
    });

    // LANCEMENT
    initApp();

  </script>
</body>
</html>
