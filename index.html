<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte Mansion - Directe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    /* RESET */
    body { margin: 0; padding: 0; font-family: sans-serif; background: #f5f5f5; overflow: hidden; }
    * { box-sizing: border-box; }

    /* HEADER */
    header { background: #fff; padding: 10px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; height: 60px; z-index: 1000; position: relative; }
    .brand { font-weight: bold; font-size: 14px; }
    .controls { display: flex; gap: 5px; }
    select, button { padding: 5px; border-radius: 4px; border: 1px solid #999; font-size: 12px; background: white; cursor: pointer; }
    button.primary { background: black; color: white; border-color: black; }
    button.accent { background: #0066cc; color: white; border: none; }

    /* DASHBOARD */
    #dashboard { background: white; padding: 10px; font-size: 12px; height: 140px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 5px; z-index: 1000; position: relative; }
    .stats { display: flex; justify-content: space-between; font-weight: bold; color: #555; }
    .inputs { display: flex; gap: 5px; }
    .inputs input, .inputs textarea { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }

    /* CARTE */
    #map { width: 100%; height: calc(100vh - 200px); background: #e5e5e5; z-index: 1; }

    /* POPUP */
    .popup-content { text-align: center; min-width: 150px; }
    .btn-done { background: #2ecc71; color: white; border: none; padding: 8px; width: 100%; margin-top: 5px; cursor: pointer; border-radius: 4px; }
  </style>
</head>
<body>

  <header>
    <div class="brand">Mansion Prospection</div>
    <div class="controls">
      <select id="negociateur">
        <option value="Alexis">Alexis (NO)</option>
        <option value="Nicolas">Nicolas (NE)</option>
        <option value="Thibault">Thibault (SO)</option>
        <option value="Laurent">Laurent (SE)</option>
      </select>
      <button id="btnGps" class="accent">üìç GPS</button>
      <button id="btnLoad">‚¨áÔ∏è Charger +</button>
    </div>
  </header>

  <div id="dashboard">
    <div class="stats">
      <span id="timer">00:00:00</span>
      <span id="coverage">--% Couvert</span>
    </div>
    <div class="inputs">
      <input type="number" id="flyers" placeholder="Nb Flyers">
      <textarea id="notes" placeholder="Notes..."></textarea>
    </div>
    <div style="margin-top:5px; display:flex; gap:5px;">
      <button id="btnStart" class="primary" style="flex:1;">‚ñ∂ D√©marrer</button>
      <button id="btnSave" disabled style="flex:1; background:#eee;">üíæ Sauver</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    /* --- 1. INITIALISATION CARTE IMM√âDIATE --- */
    // On initialise la carte tout de suite, sans attendre
    const map = L.map('map').setView([44.996, -0.446], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // --- 2. CONFIGURATION ---
    const ZONES = [
      { id:1, nego:"Alexis", color:"#e74c3c", poly:[[-0.48,45.02],[-0.446,45.02],[-0.446,44.995],[-0.48,44.995]] },
      { id:2, nego:"Nicolas", color:"#3498db", poly:[[-0.446,45.02],[-0.41,45.02],[-0.41,44.995],[-0.446,44.995]] },
      { id:3, nego:"Thibault", color:"#f1c40f", poly:[[-0.48,44.995],[-0.446,44.995],[-0.446,44.96],[-0.48,44.96]] },
      { id:4, nego:"Laurent", color:"#9b59b6", poly:[[-0.446,44.995],[-0.41,44.995],[-0.41,44.96],[-0.446,44.96]] }
    ];

    // Rues en dur (pour affichage imm√©diat m√™me sans internet)
    const STATIC_STREETS = [
      {name:"Rue Nationale", pts:[[44.993,-0.445],[44.998,-0.446],[45.002,-0.447]]},
      {name:"Route de Libourne", pts:[[44.993,-0.445],[44.990,-0.440],[44.985,-0.430]]},
      {name:"Rue de la Gare", pts:[[44.995,-0.446],[44.996,-0.450],[44.997,-0.455]]},
      {name:"Av. de l'Europe", pts:[[45.000,-0.440],[45.005,-0.435]]},
      {name:"Rue Dantagnan", pts:[[44.994,-0.448],[44.994,-0.452]]},
      {name:"Rue Cousteau", pts:[[44.998,-0.442],[45.000,-0.438]]}
    ];

    // Variables globales
    const state = { nego: "Alexis", streets: {}, running: false, start: 0, interval: null, gps: null, marker: null };
    let supabaseClient = null;

    /* --- 3. DESSIN ET LOGIQUE --- */
    
    // Dessin des zones (pointill√©s)
    ZONES.forEach(z => {
       const poly = z.poly.map(p => [p[1], p[0]]); // Inversion Lat/Lon pour Leaflet
       L.polygon(poly, { color: z.color, fillOpacity: 0.05, weight: 1, dashArray: '6' }).addTo(map);
    });

    // Fonction pour dessiner une rue
    function drawStreet(name, pts, lastDate) {
      // D√©j√† dessin√©e ?
      if(state.streets[name]) return;

      // Calcul Couleur
      let color = "#bdc3c7"; // Gris par d√©faut
      if(lastDate) {
         const days = (new Date() - new Date(lastDate)) / (1000 * 3600 * 24);
         if(days <= 20) color = "#2ecc71"; // Vert
         else if(days <= 45) color = "#f39c12"; // Orange
         else color = "#e74c3c"; // Rouge
      }

      // Zone ID (Turf)
      let zoneId = "?";
      try {
        const center = pts[Math.floor(pts.length/2)];
        const pt = turf.point([center[1], center[0]]);
        const found = ZONES.find(z => turf.booleanPointInPolygon(pt, turf.polygon([z.poly])));
        if(found) zoneId = found.id;
      } catch(e) {}

      // Ligne Invisible (Clic)
      L.polyline(pts, { weight: 20, opacity: 0 }).addTo(map).on('click', (e) => {
         const safeName = name.replace(/'/g, "\\'");
         L.popup().setLatLng(e.latlng).setContent(`
           <div class="popup-content">
             <b>${name}</b><br><small>Zone ${zoneId}</small><br>
             Passage: ${lastDate || "Jamais"}<br>
             <button class="btn-done" onclick="markDone('${safeName}', ${zoneId})">‚úÖ FAIT</button>
           </div>
         `).openOn(map);
      });

      // Ligne Visible
      const layer = L.polyline(pts, { color: color, weight: 3, interactive: false }).addTo(map);
      state.streets[name] = { layer, zoneId, date: lastDate };
    }

    // Fonction globale pour marquer une rue faite
    window.markDone = async (name, zoneId) => {
        const today = new Date().toISOString().split('T')[0];
        if(state.streets[name]) {
            state.streets[name].layer.setStyle({ color: '#2ecc71' });
            state.streets[name].date = today;
        }
        map.closePopup();
        updateUI();

        if(supabaseClient) {
            await supabaseClient.from('street_passages').upsert({
                street_name: name, passage_date: today, negociateur: state.nego, zone_id: zoneId
            }, { onConflict: 'street_name' });
        }
    };

    // Mise √† jour interface (opacit√© selon n√©gociateur)
    function updateUI() {
        const myId = ZONES.find(z => z.nego === state.nego)?.id;
        
        let doneCount = 0;
        let totalCount = 0;

        Object.values(state.streets).forEach(st => {
            const isMine = (st.zoneId === myId);
            st.layer.setStyle({ opacity: isMine ? 1 : 0.2, weight: isMine ? 4 : 2 });
            
            if(isMine) {
                totalCount++;
                if(st.date) {
                    const days = (new Date() - new Date(st.date))/(8.64e7);
                    if(days <= 20) doneCount++;
                }
            }
        });

        if(totalCount > 0) {
            const pct = Math.round((doneCount / totalCount) * 100);
            document.getElementById('coverage').innerText = `${pct}% (${doneCount}/${totalCount})`;
        } else {
            document.getElementById('coverage').innerText = "N/A";
        }
    }

    // --- 4. CONNEXION ET CHARGEMENT (ASYNC) ---
    async function initData() {
        // A. Connexion Supabase
        try {
            const SUPABASE_URL = "https://wqujtckrvdhrwknplumq.supabase.co"; 
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
            if(typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch(e) { console.warn("Erreur Supabase init:", e); }

        // B. R√©cup√©ration historique
        let history = {};
        if(supabaseClient) {
            try {
                const { data } = await supabaseClient.from('street_passages').select('*');
                if(data) data.forEach(d => history[d.street_name] = d.passage_date);
            } catch(e) { console.warn("Erreur fetch history:", e); }
        }

        // C. Affichage des rues statiques
        STATIC_STREETS.forEach(s => drawStreet(s.name, s.pts, history[s.name]));
        
        updateUI();
    }

    // --- 5. EVENTS ---
    
    // Changement N√©gociateur
    document.getElementById('negociateur').addEventListener('change', (e) => {
        state.nego = e.target.value;
        updateUI();
    });

    // Bouton Charger + (Overpass)
    document.getElementById('btnLoad').addEventListener('click', async () => {
        const btn = document.getElementById('btnLoad');
        btn.innerText = "‚è≥...";
        try {
            // Requ√™te API Overpass
            const bbox = "44.98,-0.46,45.02,-0.43"; // St Andr√© Large
            const q = `[out:json][timeout:10];way["highway"~"residential|unclassified"](${bbox});out geom;`;
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q));
            const data = await res.json();
            
            let count = 0;
            data.elements.forEach(el => {
                if(el.tags && el.tags.name) {
                    const pts = el.geometry.map(p => [p.lat, p.lon]);
                    // On ne redessine pas si existe d√©j√†
                    if(!state.streets[el.tags.name]) {
                        drawStreet(el.tags.name, pts, null); // Pas d'historique connu pour les nouvelles rues pour l'instant
                        count++;
                    }
                }
            });
            alert(`${count} rues ajout√©es !`);
            updateUI();
        } catch(e) {
            alert("Erreur chargement rues : " + e.message);
        }
        btn.innerText = "‚¨áÔ∏è Charger +";
    });

    // GPS
    document.getElementById('btnGps').addEventListener('click', () => {
        if(state.gps) {
            navigator.geolocation.clearWatch(state.gps);
            state.gps = null;
            if(state.marker) map.removeLayer(state.marker);
            document.getElementById('btnGps').innerText = "üìç GPS";
        } else {
            document.getElementById('btnGps').innerText = "üõë Stop";
            state.gps = navigator.geolocation.watchPosition(pos => {
                const latlng = [pos.coords.latitude, pos.coords.longitude];
                if(!state.marker) state.marker = L.circleMarker(latlng, { radius:8, color:'white', fillColor:'#007AFF', fillOpacity:1 }).addTo(map);
                else state.marker.setLatLng(latlng);
            }, null, { enableHighAccuracy: true });
        }
    });

    // D√©marrer Tourn√©e
    document.getElementById('btnStart').addEventListener('click', function() {
        state.running = !state.running;
        this.innerText = state.running ? "‚è∏ Pause" : "‚ñ∂ D√©marrer";
        document.getElementById('btnSave').disabled = !state.running;
        
        if(state.running) {
            state.start = Date.now();
            state.interval = setInterval(() => {
                const s = Math.floor((Date.now() - state.start)/1000);
                const date = new Date(s * 1000).toISOString().substr(11, 8);
                document.getElementById('timer').innerText = date;
            }, 1000);
        } else {
            clearInterval(state.interval);
        }
    });

    // Lancement
    initData();

  </script>
</body>
</html>
