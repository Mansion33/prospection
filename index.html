<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte de Prospection - Mansion Bordeaux</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; overflow: hidden; }
    * { box-sizing: border-box; }

    header {
      background: #fff; padding: 10px 15px; border-bottom: 1px solid #ddd;
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
    }
    .brand { font-weight: 700; font-size: 15px; }
    .controls { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

    select, button {
      font-size: 13px; padding: 6px 10px;
      border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer;
    }
    button.primary { background: #000; color: #fff; border-color: #000; }
    button.accent { background: #0066cc; color: #fff; border: none; }

    #dashboard {
      background: #fff; border-bottom: 1px solid #ddd; padding: 10px 15px;
      height: 140px; display:flex; flex-direction:column; gap:8px; font-size: 12px;
    }
    .stats { display:flex; justify-content:space-between; color:#555; font-weight:600; }
    .inputs { display:flex; gap:6px; }
    .inputs input, .inputs textarea {
      flex:1; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:12px;
    }
    .inputs textarea { resize:vertical; min-height:32px; }

    #map { width:100%; height:calc(100vh - 200px); background:#e5e5e5; }

    #loader {
      position:fixed; inset:0; background:#fff; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      transition:opacity .4s;
    }
    #loader.hidden { opacity:0; pointer-events:none; }

    .spinner {
      width:40px; height:40px; border:4px solid #eee; border-top:4px solid #000;
      border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px auto;
    }
    @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

    .popup-content { text-align:center; min-width:160px; }
    .btn-done { background:#2ecc71; color:#fff; border:none; padding:8px; width:100%; margin-top:6px; border-radius:4px; cursor:pointer; }

    @media(max-width:600px){
      header{flex-direction:column; align-items:flex-start;}
      #map{height:calc(100vh - 230px);}
    }
  </style>
</head>
<body>

  <div id="loader">
    <div style="text-align:center">
      <div class="spinner"></div>
      <div id="loaderText">Construction de la carte...</div>
      <small style="color:#999; display:block; margin-top:4px;">(d√©blocage automatique)</small>
    </div>
  </div>

  <header>
    <div class="brand">Mansion Bordeaux <span style="font-weight:400; color:#666;">| Prospection</span></div>
    <div class="controls">
      <select id="negociateur">
        <option value="Alexis">Alexis (Nord-Ouest)</option>
        <option value="Nicolas">Nicolas (Nord-Est)</option>
        <option value="Thibault">Thibault (Sud-Ouest)</option>
        <option value="Laurent">Laurent (Sud-Est)</option>
      </select>
      <button id="btnGps" class="accent">üìç GPS</button>
      <button id="btnLoad">‚ûï Rues</button>
    </div>
  </header>

  <div id="dashboard">
    <div class="stats">
      <span id="timer">00:00:00</span>
      <span id="coverage">0% couvert</span>
    </div>
    <div class="inputs">
      <input type="number" id="flyers" placeholder="Nb flyers" />
      <textarea id="notes" placeholder="Notes / adresses..."></textarea>
    </div>
    <div style="display:flex; gap:6px;">
      <button id="btnStart" class="primary" style="flex:1;">‚ñ∂ D√©marrer</button>
      <button id="btnSave" style="flex:1; background:#eee;" disabled>üíæ Enregistrer</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // ---------- util loader ----------
    const loaderEl = document.getElementById('loader');
    function hideLoader() {
      if (loaderEl && !loaderEl.classList.contains('hidden')) {
        loaderEl.classList.add('hidden');
      }
    }
    // s√©curit√© anti ‚Äúchargement infini‚Äù
    setTimeout(hideLoader, 3000);

    // ---------- config carte ----------
    const map = L.map('map').setView([44.996, -0.446], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    const ZONES = [
      { id:1, nego:"Alexis",  color:"#e74c3c", poly:[[-0.48,45.02],[-0.446,45.02],[-0.446,44.995],[-0.48,44.995]] },
      { id:2, nego:"Nicolas", color:"#3498db", poly:[[-0.446,45.02],[-0.41,45.02],[-0.41,44.995],[-0.446,44.995]] },
      { id:3, nego:"Thibault",color:"#f1c40f", poly:[[-0.48,44.995],[-0.446,44.995],[-0.446,44.96],[-0.48,44.96]] },
      { id:4, nego:"Laurent", color:"#9b59b6", poly:[[-0.446,44.995],[-0.41,44.995],[-0.41,44.96],[-0.446,44.96]] }
    ];

    // r√©seau minimum pour que la carte soit toujours utilisable
    const BASE_STREETS = [
      {name:"Rue Nationale",        pts:[[44.993,-0.445],[44.998,-0.446],[45.002,-0.447]]},
      {name:"Route de Libourne",    pts:[[44.993,-0.445],[44.990,-0.440],[44.985,-0.430]]},
      {name:"Rue de la Gare",       pts:[[44.995,-0.446],[44.996,-0.450],[44.997,-0.455]]},
      {name:"Av. de l'Europe",      pts:[[45.000,-0.440],[45.005,-0.435]]},
      {name:"Rue Dantagnan",        pts:[[44.994,-0.448],[44.994,-0.452]]},
      {name:"Chemin Bois Milon",    pts:[[44.985,-0.445],[44.980,-0.445]]},
      {name:"Rue Cousteau",         pts:[[44.998,-0.442],[45.000,-0.438]]}
    ];

    // ---------- Supabase (optionnel) ----------
    const SUPABASE_URL = "https://wqujtckrvdhrwknplumq.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";

    let supabaseClient = null;
    if (window.supabase) {
      try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      } catch (e) {
        console.warn("Erreur init Supabase :", e);
      }
    }

    // ---------- √©tat global ----------
    const state = {
      nego: "Alexis",
      streets: {},   // {name: {layer, zoneId, date}}
      running: false,
      startTime: 0,
      timerId: null
    };

    const ui = {
      nego: document.getElementById('negociateur'),
      coverage: document.getElementById('coverage'),
      timer: document.getElementById('timer'),
      btnLoad: document.getElementById('btnLoad')
    };

    // ---------- fonctions principales ----------
    async function startApp() {
      try {
        // 1. dessiner les secteurs
        ZONES.forEach(z => {
          const latlngs = z.poly.map(p => [p[1], p[0]]);
          L.polygon(latlngs, {
            color: z.color, weight: 2, fillOpacity: 0.06, dashArray: "4"
          }).addTo(map);
        });

        // 2. historique rues depuis Supabase (si dispo)
        let history = {};
        if (supabaseClient) {
          try {
            const { data, error } = await supabaseClient
              .from('street_passages')
              .select('street_name, passage_date');
            if (!error && data) {
              data.forEach(row => { history[row.street_name] = row; });
            }
          } catch (e) {
            console.warn("Lecture Supabase impossible (mode offline).");
          }
        }

        // 3. dessiner le r√©seau minimal
        BASE_STREETS.forEach(s => drawStreet(s.name, s.pts, history[s.name]));

        updateUI();
        hideLoader();
      } catch (err) {
        console.error("Erreur startApp:", err);
        hideLoader();
        alert("Erreur lors du chargement de la carte.");
      }
    }

    function drawStreet(name, coords, hist) {
      let color = "#bdc3c7";
      let lastDate = hist ? hist.passage_date : null;

      if (lastDate) {
        const days = (new Date() - new Date(lastDate)) / 86400000;
        if (days <= 20) color = "#2ecc71";
        else if (days <= 45) color = "#f39c12";
        else color = "#e74c3c";
      }

      // d√©terminer le secteur
      let zoneId = null;
      try {
        const mid = coords[Math.floor(coords.length / 2)];
        const pt = turf.point([mid[1], mid[0]]);
        const zone = ZONES.find(z => turf.booleanPointInPolygon(pt, turf.polygon([z.poly])));
        if (zone) zoneId = zone.id;
      } catch (e) {
        console.warn("Erreur turf pour", name, e);
      }

      // couche cliquable invisible (large)
      L.polyline(coords, { weight: 25, opacity: 0 })
        .addTo(map)
        .on('click', e => openStreetPopup(name, zoneId, lastDate, e.latlng));

      // couche visible
      const layer = L.polyline(coords, { color, weight: 4, opacity: 0.8 }).addTo(map);

      state.streets[name] = { layer, zoneId, date: lastDate };
    }

    function openStreetPopup(name, zoneId, lastDate, latlng) {
      const safeName = name.replace(/'/g, "\\'");
      const content = `
        <div class="popup-content">
          <b>${name}</b><br>
          <small>Secteur : ${zoneId || "?"}</small><br>
          <small>Dernier passage : ${lastDate || "Jamais"}</small>
          <button class="btn-done" onclick="window.__doStreet('${safeName}', ${zoneId || 'null'})">
            ‚úÖ Marquer comme fait
          </button>
        </div>
      `;
      L.popup().setLatLng(latlng).setContent(content).openOn(map);
    }

    window.__doStreet = async (name, zoneId) => {
      const today = new Date().toISOString().split('T')[0];
      const st = state.streets[name];
      if (st) {
        st.layer.setStyle({ color: "#2ecc71" });
        st.date = today;
      }
      map.closePopup();
      updateUI();

      if (supabaseClient) {
        try {
          await supabaseClient.from('street_passages').upsert({
            street_name: name,
            passage_date: today,
            negociateur: state.nego,
            zone_id: zoneId
          }, { onConflict: 'street_name' });
        } catch (e) {
          console.warn("Erreur sauvegarde Supabase:", e);
        }
      }
    };

    function updateUI() {
      const myZone = ZONES.find(z => z.nego === state.nego)?.id;

      // opacit√© des rues selon le secteur
      Object.values(state.streets).forEach(st => {
        const active = (st.zoneId === myZone);
        st.layer.setStyle({
          opacity: active ? 1 : 0.25,
          weight: active ? 4 : 2
        });
      });

      // couverture
      if (!myZone) {
        ui.coverage.textContent = "Hors zone";
        return;
      }
      const list = Object.values(state.streets).filter(st => st.zoneId === myZone);
      if (!list.length) {
        ui.coverage.textContent = "0% (0/0)";
        return;
      }
      const now = new Date();
      const done = list.filter(st => st.date && (now - new Date(st.date)) / 86400000 <= 20).length;
      const pct = Math.round(done * 100 / list.length);
      ui.coverage.textContent = `${pct}% (${done}/${list.length})`;
    }

    // ---------- Overpass en bonus (bouton ‚ûï Rues) ----------
    ui.btnLoad.addEventListener('click', async () => {
      const btn = ui.btnLoad;
      btn.textContent = "‚è≥";
      try {
        const q = `[out:json][timeout:15];
          way["highway"~"residential|unclassified"](44.98,-0.46,45.01,-0.43);
          out geom;`;
        const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q));
        if (!res.ok) throw new Error("Overpass " + res.status);
        const data = await res.json();
        let added = 0;
        data.elements.forEach(el => {
          if (el.type === "way" && el.tags && el.tags.name && !state.streets[el.tags.name]) {
            const pts = el.geometry.map(p => [p.lat, p.lon]);
            drawStreet(el.tags.name, pts, null);
            added++;
          }
        });
        alert(added + " rues suppl√©mentaires charg√©es.");
        updateUI();
      } catch (e) {
        alert("Impossible de charger les rues via Overpass (serveur satur√©).");
        console.warn(e);
      }
      btn.textContent = "‚ûï Rues";
    });

    // ---------- changement n√©gociateur ----------
    document.getElementById('negociateur').addEventListener('change', e => {
      state.nego = e.target.value;
      updateUI();
    });

    // (Timer & GPS pourront √™tre remis ensuite)

    // lancement
    startApp();
  </script>
</body>
</html>
