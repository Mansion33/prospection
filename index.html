<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mansion - Version Finale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    /* --- STYLE G√âN√âRAL --- */
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #fff; overflow: hidden; }
    
    header { background: #fff; height: 60px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; z-index: 1000; position: relative; }
    .controls { display: flex; gap: 5px; }
    select, button { height: 36px; padding: 0 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; font-size: 13px; cursor: pointer; }
    button.accent { background: #007AFF; color: white; border: none; }
    
    #dashboard { background: rgba(255,255,255,0.95); padding: 10px; position: absolute; top: 60px; left: 0; right: 0; z-index: 900; border-bottom: 1px solid #eee; backdrop-filter: blur(4px); }
    .stats { font-size: 14px; font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .btn-row { display: flex; gap: 5px; }
    .btn-row button { flex: 1; }

    #map { width: 100%; height: calc(100vh - 60px); z-index: 1; }

    /* POPUP STYLIS√âE */
    .leaflet-popup-content { margin: 12px; text-align: center; min-width: 200px; }
    .street-title { font-size: 15px; font-weight: 800; display: block; margin-bottom: 2px; }
    .street-info { font-size: 12px; color: #666; margin-bottom: 10px; display: block; }
    
    .popup-actions { display: flex; gap: 5px; margin-top: 8px; }
    .btn-validate { background: #2ecc71; color: white; border: none; padding: 10px; border-radius: 6px; flex: 2; font-weight: bold; }
    .btn-streetview { background: #34495e; color: white; border: none; padding: 10px; border-radius: 6px; flex: 1; font-size: 18px; }

    /* Long Press Feedback */
    .long-press-indicator {
        position: absolute; border: 2px solid #000; border-radius: 50%;
        width: 40px; height: 40px; transform: translate(-50%, -50%);
        animation: ripple 1s infinite; pointer-events: none; z-index: 2000;
    }
    @keyframes ripple { 0% { opacity:1; transform:translate(-50%, -50%) scale(0.5); } 100% { opacity:0; transform:translate(-50%, -50%) scale(1.5); } }
  </style>
</head>
<body>

  <header>
    <div style="font-weight:800; font-size:14px;">MANSION</div>
    <div class="controls">
      <select id="negociateur">
        <option value="Alexis">Alexis (NO)</option>
        <option value="Nicolas">Nicolas (NE)</option>
        <option value="Thibault">Thibault (SO)</option>
        <option value="Laurent">Laurent (SE)</option>
      </select>
      <button id="btnLoad">‚¨áÔ∏è Charger Rues</button>
    </div>
  </header>

  <div id="dashboard">
    <div class="stats">
      <span id="timer">00:00:00</span>
      <span id="coverage">0% Couvert</span>
    </div>
    <div class="btn-row">
      <button id="btnStart" class="accent">‚ñ∂ D√©marrer</button>
      <button id="btnPause" style="background:#f1c40f; display:none;">‚è∏ Pause</button>
      <button id="btnGps">üìç Moi</button>
    </div>
    <div style="font-size:10px; color:#999; margin-top:5px; text-align:center;">
      ‚ÑπÔ∏è Appui long sur la carte = Street View
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- 1. CONFIGURATION ---
    const CENTER = [44.996, -0.446]; // St Andr√© Centre
    const map = L.map('map', { 
        zoomControl: false, 
        tap: false // Optimisation mobile
    }).setView(CENTER, 15);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const ZONES = [
      { id:1, nego:"Alexis", color:"#e74c3c", poly:[CENTER,[44.996,-0.448],[45.02,-0.46],[45.02,-0.49],[44.99,-0.49],[44.994,-0.45]] },
      { id:2, nego:"Nicolas", color:"#3498db", poly:[CENTER,[44.996,-0.445],[45.02,-0.44],[45.02,-0.40],[44.995,-0.40],[44.9945,-0.44]] },
      { id:3, nego:"Thibault", color:"#f1c40f", poly:[CENTER,[44.994,-0.45],[44.99,-0.49],[44.95,-0.49],[44.95,-0.446],[44.993,-0.446]] },
      { id:4, nego:"Laurent", color:"#9b59b6", poly:[CENTER,[44.993,-0.446],[44.95,-0.446],[44.95,-0.40],[44.995,-0.40],[44.995,-0.445]] }
    ];

    // Rues Statiques (Lignes droites pour affichage imm√©diat, cliquer sur "Charger" pour les courbes)
    const BASE_STREETS = [
      {name:"Rue Nationale", pts:[[44.993,-0.445],[44.998,-0.446],[45.005,-0.447]]},
      {name:"Route de Libourne", pts:[[44.993,-0.445],[44.990,-0.440],[44.985,-0.430]]},
      {name:"Rue de la Gare", pts:[[44.995,-0.446],[44.996,-0.450],[44.997,-0.455]]},
      {name:"Avenue de l'Europe", pts:[[45.000,-0.440],[45.005,-0.435]]},
      {name:"Rue Dantagnan", pts:[[44.994,-0.448],[44.994,-0.452]]}
    ];

    let state = { nego: "Alexis", streets: {}, timer: null, seconds: 0, gps: null, marker: null };
    let supabaseClient = null;

    // --- 2. LOGIQUE COULEURS & DESSIN ---

    // Votre r√®gle stricte : Rouge (Jamais), Orange (+20j), Vert (<20j)
    function getColor(date) {
        if (!date) return "#ff3b30"; // ROUGE (Jamais fait)
        const diffDays = (new Date() - new Date(date)) / (1000 * 3600 * 24);
        if (diffDays <= 20) return "#2ecc71"; // VERT (Fait r√©cent)
        return "#ff9500"; // ORANGE (A refaire)
    }

    function drawStreet(name, pts, lastDate) {
        if(state.streets[name]) return; // D√©j√† affich√©

        // 1. Trouver Secteur
        let zoneId = null;
        try {
            const center = pts[Math.floor(pts.length/2)];
            const pt = turf.point([center[1], center[0]]);
            const z = ZONES.find(z => {
                const poly = z.poly.map(p => [p[1], p[0]]); // Inversion pour Turf
                // Fermeture polygone
                if(poly[0][0] !== poly[poly.length-1][0]) poly.push(poly[0]);
                return turf.booleanPointInPolygon(pt, turf.polygon([poly]));
            });
            if(z) zoneId = z.id;
        } catch(e) {}

        const color = getColor(lastDate);

        // 2. Ligne de CLIC (Large, Invisible, Au-dessus)
        // C'est celle-ci qui intercepte le doigt
        const hitLayer = L.polyline(pts, { weight: 25, opacity: 0, zIndex: 1000 }).addTo(map);

        // 3. Ligne VISUELLE (Fine, Color√©e, En dessous)
        // PointerEvents: none pour laisser le clic passer √† la hitLayer
        const visLayer = L.polyline(pts, { 
            color: color, 
            weight: 4, 
            opacity: 0.9, 
            lineCap: 'round', // Bords arrondis pour look organique
            interactive: false 
        }).addTo(map);

        // Interaction
        hitLayer.on('click', (e) => {
            // A. ZOOM (fitBounds avec padding pour bien voir la rue)
            map.fitBounds(hitLayer.getBounds(), { padding: [50, 50], maxZoom: 18, animate: true, duration: 0.5 });

            // B. POPUP
            const safeName = name.replace(/'/g, "\\'");
            const dateStr = lastDate ? new Date(lastDate).toLocaleDateString() : "Jamais";
            
            // Calcul coordonn√©es pour StreetView (milieu de rue ou point de clic)
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            const popupContent = `
                <span class="street-title">${name}</span>
                <span class="street-info">Secteur ${zoneId || "?"} ‚Ä¢ Dernier: <strong>${dateStr}</strong></span>
                <div class="popup-actions">
                    <button class="btn-validate" onclick="validateStreet('${safeName}', ${zoneId})">‚úÖ VALIDER</button>
                    <button class="btn-streetview" onclick="openStreetView(${lat}, ${lng})">üëÅÔ∏è</button>
                </div>
            `;
            
            L.popup({ offset: [0, -5] }).setLatLng(e.latlng).setContent(popupContent).openOn(map);
        });

        state.streets[name] = { hit: hitLayer, vis: visLayer, zoneId: zoneId, date: lastDate };
    }

    // --- 3. FONCTIONS GLOBALES (Window) ---

    window.validateStreet = async (name, zoneId) => {
        const today = new Date().toISOString().split('T')[0];
        
        // Mise √† jour visuelle imm√©diate
        if(state.streets[name]) {
            state.streets[name].vis.setStyle({ color: '#2ecc71' }); // Vert direct
            state.streets[name].date = today;
        }
        map.closePopup();
        updateUI();

        // Sauvegarde Supabase
        if(supabaseClient) {
            await supabaseClient.from('street_passages').upsert({
                street_name: name, passage_date: today, negociateur: state.nego, zone_id: zoneId
            }, { onConflict: 'street_name' });
        }
    };

    window.openStreetView = (lat, lng) => {
        // Lien universel Google Street View
        const url = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
        window.open(url, '_blank');
    };

    // --- 4. GESTION LONG PRESS (APPUI LONG) ---
    let pressTimer;
    map.on('mousedown touchstart', (e) => {
        // On ignore si on clique sur un control ou popup
        if(e.originalEvent.target.closest('.leaflet-control') || e.originalEvent.target.closest('.leaflet-popup')) return;

        pressTimer = setTimeout(() => {
            // Cr√©er indicateur visuel
            const icon = L.divIcon({ className: 'long-press-indicator' });
            const marker = L.marker(e.latlng, { icon: icon }).addTo(map);
            setTimeout(() => map.removeLayer(marker), 1000);

            // Ouvrir Street View
            openStreetView(e.latlng.lat, e.latlng.lng);
        }, 800); // 800ms = appui long
    });

    map.on('mouseup touchend mousemove touchmove', () => {
        clearTimeout(pressTimer);
    });

    // --- 5. INITIALISATION ---

    async function init() {
        // Init Supabase
        try {
            const URL = "https://wqujtckrvdhrwknplumq.supabase.co"; 
            const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
            if(typeof supabase !== 'undefined') supabaseClient = supabase.createClient(URL, KEY);
        } catch(e) {}

        // Dessin des Zones (Transparentes)
        ZONES.forEach(z => {
            const pts = z.poly.map(p => [p[0], p[1]]); // Leaflet
            L.polygon(pts, { color: z.color, fillOpacity: 0.05, weight: 1, dashArray: '5', interactive: false }).addTo(map);
        });

        // Chargement des donn√©es existantes
        let history = {};
        if(supabaseClient) {
            const { data } = await supabaseClient.from('street_passages').select('*');
            if(data) data.forEach(d => history[d.street_name] = d.passage_date);
        }

        // Dessin Rues de base
        BASE_STREETS.forEach(s => drawStreet(s.name, s.pts, history[s.name]));
        
        updateUI();
    }

    // --- 6. UI & BOUTONS ---

    function updateUI() {
        const myZone = ZONES.find(z => z.nego === state.nego)?.id;
        let total = 0, done = 0;

        Object.values(state.streets).forEach(st => {
            const isMine = (st.zoneId === myZone);
            
            // Gestion de l'opacit√© : Focus sur mon secteur
            st.vis.setStyle({ opacity: isMine ? 0.9 : 0.2, weight: isMine ? 4 : 2 });
            
            // Gestion du plan : Clickable au dessus
            if(isMine) {
                st.hit.bringToFront(); 
                total++;
                if(st.date && (new Date() - new Date(st.date))/(8.64e7) <= 20) done++;
            }
        });

        document.getElementById('coverage').innerText = total ? `${Math.round((done/total)*100)}%` : "0%";
    }

    // Bouton Charger (Overpass) -> C'est √ßa qui donne le look organique
    document.getElementById('btnLoad').addEventListener('click', async () => {
        const btn = document.getElementById('btnLoad');
        btn.innerText = "‚è≥ Chargement...";
        
        // Zone St Andr√© Large
        const q = `[out:json][timeout:15];way["highway"~"residential|unclassified|living_street"](44.97,-0.48,45.02,-0.41);out geom;`;
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q));
            const data = await res.json();
            
            // Fusion des segments portant le m√™me nom (optionnel mais mieux)
            // Ici on dessine direct pour simplifier
            data.elements.forEach(el => {
                if(el.tags && el.tags.name) {
                    const pts = el.geometry.map(p => [p.lat, p.lon]);
                    // On garde l'historique si on l'a d√©j√†
                    const current = state.streets[el.tags.name];
                    const date = current ? current.date : null;
                    drawStreet(el.tags.name, pts, date);
                }
            });
            updateUI();
            alert("Rues charg√©es !");
        } catch(e) { alert("Erreur r√©seau"); }
        btn.innerText = "‚¨áÔ∏è Charger Rues";
    });

    // Timer Logic
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');

    btnStart.addEventListener('click', () => {
        btnStart.style.display = 'none';
        btnPause.style.display = 'inline-block';
        startTimer();
    });

    btnPause.addEventListener('click', () => {
        if(state.timer) {
            // Mettre en pause
            clearInterval(state.timer);
            state.timer = null;
            btnPause.innerText = "‚ñ∂ Reprendre";
            btnPause.style.background = "#007AFF";
        } else {
            // Reprendre
            startTimer();
            btnPause.innerText = "‚è∏ Pause";
            btnPause.style.background = "#f1c40f";
        }
    });

    function startTimer() {
        state.timer = setInterval(() => {
            state.seconds++;
            const d = new Date(state.seconds * 1000).toISOString().substr(11, 8);
            document.getElementById('timer').innerText = d;
        }, 1000);
    }

    document.getElementById('negociateur').addEventListener('change', (e) => {
        state.nego = e.target.value;
        updateUI();
    });

    document.getElementById('btnGps').addEventListener('click', () => {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const ll = [pos.coords.latitude, pos.coords.longitude];
                map.setView(ll, 17);
                L.circleMarker(ll, {radius:8, color:'white', fillColor:'#2980b9', fillOpacity:1}).addTo(map);
            });
        }
    });

    init();

  </script>
</body>
</html>
