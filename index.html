<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mansion V9 - Satellite & Context</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- VARIABLES --- */
    :root {
      --bg: #F4F4F6;
      --card: rgba(255, 255, 255, 0.95);
      --text: #1C1C1E;
      --primary: #000;
      --success: #34C759;
      --shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    /* Mode Satellite (Dark UI forced) */
    body.sat-mode { --text: #fff; --card: rgba(20, 20, 20, 0.85); --bg: #000; }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); overflow: hidden; color: var(--text); transition: background 0.3s; }

    /* MAP */
    #map { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; z-index: 1; background: #ddd; }

    /* HEADER */
    header {
      position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
      background: var(--card); padding: 15px 20px 20px;
      border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
      box-shadow: var(--shadow); backdrop-filter: blur(15px);
      transition: background 0.3s;
    }
    .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .brand { font-weight: 800; font-size: 20px; letter-spacing: -0.5px; }

    .stats-row { display: flex; justify-content: space-between; align-items: flex-end; }
    .nego-badge { background: rgba(120,120,128,0.1); padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 6px; }
    select { background: transparent; border: none; font-weight: 700; color: var(--text); outline: none; }

    /* Progress */
    .progress-track { width: 100%; height: 6px; background: rgba(120,120,128,0.2); border-radius: 10px; margin-top: 15px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: var(--success); transition: width 0.5s; }

    /* WIDGETS */
    .widgets { position: absolute; top: 160px; right: 15px; z-index: 900; display: flex; flex-direction: column; gap: 12px; }
    .fab { width: 48px; height: 48px; border-radius: 50%; background: var(--card); color: var(--text); border: none; box-shadow: var(--shadow); font-size: 22px; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
    .fab:active { transform: scale(0.9); }
    .active-mode { border: 2px solid var(--success); color: var(--success); }

    /* POPUP (Bottom Sheet) */
    #bottom-sheet {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 1100;
      background: var(--card); border-top-left-radius: 32px; border-top-right-radius: 32px;
      padding: 24px 20px 40px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
      backdrop-filter: blur(20px);
    }
    #bottom-sheet.active { transform: translateY(0); }

    .sheet-title { font-size: 20px; font-weight: 800; margin-bottom: 5px; line-height: 1.1; }
    .sheet-meta { font-size: 13px; color: var(--success); font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 6px; }

    /* Info Cards */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .info-card { background: rgba(120,120,128,0.08); padding: 15px; border-radius: 18px; text-align: center; }
    .ic-icon { font-size: 24px; margin-bottom: 5px; }
    .ic-val { font-weight: 800; font-size: 16px; }
    .ic-label { font-size: 11px; font-weight: 600; opacity: 0.6; }

    /* Buttons */
    .btn-main { width: 100%; background: var(--text); color: var(--bg); padding: 18px; border-radius: 20px; font-weight: 800; border: none; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .close-btn { position: absolute; top: 24px; right: 20px; background: rgba(120,120,128,0.1); border:none; width:30px; height:30px; border-radius:50%; font-weight:bold; cursor:pointer; color: var(--text); }

    /* TOAST */
    .toast { position: absolute; top: 140px; left: 50%; transform: translateX(-50%); background: #000; color: white; padding: 10px 20px; border-radius: 30px; font-weight: 700; font-size: 13px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
    .toast.show { opacity: 1; margin-top: 10px; }

    /* Loader */
    #loader { position: absolute; bottom: 50%; left: 50%; transform: translate(-50%, 50%); background: white; color: black; padding: 15px 30px; border-radius: 50px; font-weight: 800; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: opacity 0.5s; }

  </style>
</head>
<body>

  <header>
    <div class="top-row">
      <div class="brand">MANSION V9</div>
      <div style="font-weight:800; font-size:14px">üéØ <span id="daily">0</span>/10</div>
    </div>
    <div class="stats-row">
      <div class="nego-badge">
        <span id="u-icon">üëë</span>
        <select id="negociateur">
          <option value="Alexis">Alexis</option>
          <option value="Nicolas">Nicolas</option>
          <option value="Thibault">Thibault</option>
          <option value="Laurent">Laurent</option>
        </select>
      </div>
    </div>
    <div class="progress-track"><div class="progress-fill" id="p-bar"></div></div>
  </header>

  <div class="widgets">
    <button class="fab" id="btnSat" onclick="toggleMapMode()">üõ∞Ô∏è</button>
    <button class="fab" id="btnGps" onclick="toggleGPS()">üìç</button>
  </div>

  <div id="loader">Chargement...</div>
  <div id="toast" class="toast">Action Valid√©e</div>

  <div id="map"></div>

  <div id="bottom-sheet">
    <button class="close-btn" onclick="closeSheet()">‚úï</button>
    
    <div class="sheet-title" id="s-name">Rue...</div>
    <div class="sheet-meta" id="s-meta">üî¥ Jamais faite</div>

    <div class="info-grid">
      <div class="info-card">
        <div class="ic-icon" id="c-icon">üè†</div>
        <div class="ic-val" id="c-type">Maison</div>
        <div class="ic-label">Environnement</div>
      </div>
      <div class="info-card">
        <div class="ic-icon">üì¨</div>
        <div class="ic-val" id="c-est">~25</div>
        <div class="ic-label">Bo√Ætes estim√©es</div>
      </div>
    </div>

    <button class="btn-main" onclick="validateStreet()">‚úÖ ZONE TERMIN√âE</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- CONFIG ---
    const CENTER_LAT = 44.9945;
    const CENTER_LNG = -0.4465;
    const SB_URL = "https://wqujtckrvdhrwknplumq.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    
    // ZONES
    const ZONES = [
      { id: 1, nego: "Alexis", color: "#e74c3c", poly: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG-0.05], [CENTER_LAT, CENTER_LNG-0.05]] },
      { id: 2, nego: "Nicolas", color: "#3498db", poly: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG+0.05], [CENTER_LAT, CENTER_LNG+0.05]] },
      { id: 3, nego: "Thibault", color: "#f1c40f", poly: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG-0.05], [CENTER_LAT, CENTER_LNG-0.05]] },
      { id: 4, nego: "Laurent", color: "#9b59b6", poly: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG+0.05], [CENTER_LAT, CENTER_LNG+0.05]] }
    ];
    
    const state = { streets: {}, nego: "Alexis", selected: null, daily: 0, satMode: false };
    const EMOJIS = { "Alexis": "üëë", "Nicolas": "üöÄ", "Thibault": "ü¶Å", "Laurent": "‚ö°" };

    // --- INIT MAP ---
    const map = L.map('map', { zoomControl: false, tap: false }).setView([CENTER_LAT, CENTER_LNG], 15);

    // 1. Layer PLAN (D√©faut)
    const layerPlan = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);

    // 2. Layer SATELLITE (Esri World Imagery - Gratuit & Tr√®s bonne qualit√©)
    const layerSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });

    // Dessin Zones
    ZONES.forEach(z => L.polygon(z.poly, { color: z.color, weight: 1, fillOpacity: 0.05, interactive: false }).addTo(map));

    // --- TOGGLE SATELLITE ---
    window.toggleMapMode = () => {
        state.satMode = !state.satMode;
        const btn = document.getElementById('btnSat');
        
        if(state.satMode) {
            map.removeLayer(layerPlan);
            map.addLayer(layerSat);
            btn.classList.add('active-mode');
            btn.innerText = "üó∫Ô∏è"; // Ic√¥ne pour revenir au plan
            document.body.classList.add('sat-mode');
            // On rend les trac√©s blancs/brillants pour contraste sur sat
            updateStreetContrast(true);
        } else {
            map.removeLayer(layerSat);
            map.addLayer(layerPlan);
            btn.classList.remove('active-mode');
            btn.innerText = "üõ∞Ô∏è";
            document.body.classList.remove('sat-mode');
            updateStreetContrast(false);
        }
    };

    function updateStreetContrast(isSat) {
        Object.values(state.streets).forEach(st => {
            // Si Satellite : traits plus clairs/blancs si pas fait. Si Plan : rouge
            const color = getStatusColor(st.dbData, isSat);
            st.vis.setStyle({ color: color, opacity: isSat ? 0.8 : 0.6 });
        });
    }

    // --- ANALYSE ENVIRONNEMENT ---
    function analyzeEnvironment(latlngs) {
        // Calcul longueur
        const line = turf.lineString(latlngs.map(p => [p[1], p[0]]));
        const lengthM = turf.length(line, {units: 'kilometers'}) * 1000;
        
        // Calcul sinuosit√© (distance vol d'oiseau vs distance r√©elle)
        const start = latlngs[0];
        const end = latlngs[latlngs.length - 1];
        const distDirect = turf.distance(turf.point([start[1], start[0]]), turf.point([end[1], end[0]]), {units: 'kilometers'}) * 1000;
        const sinuosity = lengthM / distDirect;

        // Logique "Sherlock Holmes" üïµÔ∏è‚Äç‚ôÇÔ∏è
        // Rue courte (<150m) et sinueuse (>1.2) = Souvent impasse / lotissement pavillonnaire
        // Rue longue (>400m) et droite (<1.05) = Avenue / Collectif potentiel
        
        let type = "Pavillonnaire";
        let icon = "üè†";
        let density = 0.12; // Standard : 1 maison tous les 8-10m

        if (lengthM > 350 && sinuosity < 1.1) {
            type = "Avenue / Mixte";
            icon = "üè¢";
            density = 0.25; // Plus dense (immeubles)
        } else if (lengthM < 100) {
            type = "Impasse / Lotis.";
            icon = "üè°";
            density = 0.15;
        }

        const boxes = Math.round(lengthM * density);
        return { type, icon, boxes };
    }


    // --- DRAW STREET ---
    function drawStreet(name, latlngs, dbData) {
        const env = analyzeEnvironment(latlngs);
        const color = getStatusColor(dbData, state.satMode);

        // Ligne Visuelle (Fine & Transparente)
        const vis = L.polyline(latlngs, { color: color, weight: 3, opacity: 0.6, lineCap: 'round', interactive: false }).addTo(map);
        
        // Ligne Clic (Large & Invisible)
        const hit = L.polyline(latlngs, { weight: 25, opacity: 0 }).addTo(map);

        state.streets[name] = { vis, hit, env, dbData };

        hit.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            openSheet(name);
        });
        
        // Fix iOS Long Press conflict
        hit.on('touchstart', (e) => L.DomEvent.stopPropagation(e));
    }

    function getStatusColor(dbData, isSat) {
        if(dbData && dbData.method === 'boitage') {
            const diff = (new Date() - new Date(dbData.passage_date)) / 8.64e7;
            if(diff <= 20) return "#34C759"; // Vert (Toujours vert si fait)
        }
        // Si pas fait : Rouge sur plan, Blanc/Cyan sur Satellite pour contraste
        return isSat ? "#5ac8fa" : "#FF3B30";
    }

    // --- ACTIONS ---
    function openSheet(name) {
        state.selected = name;
        const data = state.streets[name];
        
        document.getElementById('s-name').innerText = name;
        
        // Context
        document.getElementById('c-type').innerText = data.env.type;
        document.getElementById('c-icon').innerText = data.env.icon;
        document.getElementById('c-est').innerText = "~" + data.env.boxes;

        // Status UI
        const meta = document.getElementById('s-meta');
        if(data.dbData && getStatusColor(data.dbData) === "#34C759") {
            meta.innerHTML = "üü¢ D√©j√† fait"; meta.style.color = "#34C759";
        } else {
            meta.innerHTML = "üî¥ Jamais fait"; meta.style.color = "#FF3B30";
        }

        document.getElementById('bottom-sheet').classList.add('active');
    }

    window.closeSheet = () => document.getElementById('bottom-sheet').classList.remove('active');

    window.validateStreet = async () => {
        const name = state.selected;
        if(!name) return;
        
        // Visual Update
        state.streets[name].vis.setStyle({ color: '#34C759', opacity: 0.8, weight: 5 });
        setTimeout(() => state.streets[name].vis.setStyle({ weight: 3 }), 500);

        state.daily++;
        document.getElementById('daily').innerText = state.daily;
        document.getElementById('p-bar').style.width = (state.daily/10)*100 + "%";
        
        showToast(`‚úÖ ${name} Valid√©e !`);
        closeSheet();

        const today = new Date().toISOString().split('T')[0];
        // Save local state to prevent color reset
        state.streets[name].dbData = { method: 'boitage', passage_date: today };
        
        await supabaseClient.from('street_passages').upsert({
            street_name: name, passage_date: today, negociateur: state.nego, method: 'boitage'
        }, { onConflict: 'street_name' });
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // --- IPHONE LONG PRESS (Fix final) ---
    let timer;
    const mapEl = document.getElementById('map');
    
    mapEl.addEventListener('touchstart', (e) => {
        if(e.touches.length > 1) return;
        const touch = e.touches[0];
        timer = setTimeout(() => {
             if(navigator.vibrate) navigator.vibrate(50);
             showToast("üåç Street View...");
             // Conversion Coords
             const pt = L.point(touch.clientX, touch.clientY);
             const ll = map.containerPointToLatLng(pt);
             window.open(`https://www.google.com/maps/search/?api=1&query=$${ll.lat},${ll.lng}`, '_blank');
        }, 600);
    }, {passive:false});
    
    mapEl.addEventListener('touchmove', () => clearTimeout(timer));
    mapEl.addEventListener('touchend', () => clearTimeout(timer));

    // --- LOAD ---
    async function init() {
        const { data } = await supabaseClient.from('street_passages').select('*');
        let hist = {}; if(data) data.forEach(d => hist[d.street_name] = d);

        const query = `[out:json][timeout:25]; way["highway"~"residential|unclassified|living_street"](44.96,-0.50,45.04,-0.40); out geom;`;
        const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
        const json = await res.json();

        json.elements.forEach(el => {
            if(el.tags && el.tags.name) {
                drawStreet(el.tags.name, el.geometry.map(p=>[p.lat,p.lon]), hist[el.tags.name]);
            }
        });
        document.getElementById('loader').style.display='none';
    }

    document.getElementById('negociateur').addEventListener('change', (e) => {
        state.nego = e.target.value;
        document.getElementById('u-icon').innerText = EMOJIS[state.nego];
    });

    init();
  </script>
</body>
</html>
