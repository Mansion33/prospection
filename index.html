<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mansion - Prospection R√©elle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #fff; overflow: hidden; }
    
    /* Header compact */
    header { height: 50px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; background: white; z-index: 1000; position: relative; }
    .brand { font-weight: 900; letter-spacing: -0.5px; }
    select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; }
    
    /* Dashboard flottant transparent */
    #dashboard { 
      position: absolute; top: 60px; left: 10px; right: 10px; 
      background: rgba(255,255,255,0.9); backdrop-filter: blur(4px);
      padding: 10px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 900; display: flex; flex-direction: column; gap: 8px;
    }
    
    .stats-row { display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; color: #555; }
    .actions { display: flex; gap: 5px; }
    button { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
    .btn-start { background: #000; color: #fff; }
    .btn-gps { background: #007AFF; color: #fff; }

    /* Carte plein √©cran */
    #map { width: 100%; height: calc(100vh - 50px); z-index: 1; }

    /* Popup stylis√©e */
    .leaflet-popup-content { text-align: center; margin: 10px; min-width: 200px; }
    .street-name { display: block; font-weight: 800; font-size: 14px; margin-bottom: 4px; }
    .street-meta { display: block; font-size: 11px; color: #777; margin-bottom: 10px; }
    .btn-validate { background: #2ecc71; color: white; width: 100%; padding: 10px; border-radius: 6px; margin-bottom: 5px; }
    .btn-view { background: #34495e; color: white; width: 100%; padding: 8px; border-radius: 6px; }

    /* Indicateur de chargement discret */
    #loader { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #000; color: white; padding: 5px 15px; border-radius: 20px; font-size: 11px; z-index: 2000; display: none; }
  </style>
</head>
<body>

  <header>
    <div class="brand">MANSION</div>
    <select id="negociateur">
      <option value="Alexis">Alexis (NO)</option>
      <option value="Nicolas">Nicolas (NE)</option>
      <option value="Thibault">Thibault (SO)</option>
      <option value="Laurent">Laurent (SE)</option>
    </select>
  </header>

  <div id="dashboard">
    <div class="stats-row">
      <span id="timer">00:00:00</span>
      <span id="coverage">0 rues faites</span>
    </div>
    <div class="actions">
      <button class="btn-start" id="btnStart">‚ñ∂ GO</button>
      <button class="btn-gps" id="btnGps">üìç Ma Position</button>
    </div>
  </div>

  <div id="loader">Chargement des rues...</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // 1. CENTRE DE ST ANDRE DE CUBZAC
    const CENTER_LAT = 44.9945;
    const CENTER_LNG = -0.4465;

    // 2. DEFINITION DES SECTEURS (Quadrants g√©ants pour tout couvrir)
    // On dessine des rectangles immenses qui partent du centre
    const ZONES = [
      {
        id: 1, nego: "Alexis", color: "#e74c3c", // Nord-Ouest
        poly: [[CENTER_LAT, CENTER_LNG], [45.10, CENTER_LNG], [45.10, -0.60], [CENTER_LAT, -0.60]]
      },
      {
        id: 2, nego: "Nicolas", color: "#3498db", // Nord-Est
        poly: [[CENTER_LAT, CENTER_LNG], [45.10, CENTER_LNG], [45.10, -0.30], [CENTER_LAT, -0.30]]
      },
      {
        id: 3, nego: "Thibault", color: "#f1c40f", // Sud-Ouest
        poly: [[CENTER_LAT, CENTER_LNG], [44.90, CENTER_LNG], [44.90, -0.60], [CENTER_LAT, -0.60]]
      },
      {
        id: 4, nego: "Laurent", color: "#9b59b6", // Sud-Est
        poly: [[CENTER_LAT, CENTER_LNG], [44.90, CENTER_LNG], [44.90, -0.30], [CENTER_LAT, -0.30]]
      }
    ];

    // Init Map
    const map = L.map('map', { zoomControl: false }).setView([CENTER_LAT, CENTER_LNG], 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Init Supabase
    let supabaseClient = null;
    try {
        const SB_URL = "https://wqujtckrvdhrwknplumq.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
        if(typeof supabase !== 'undefined') supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    } catch(e) {}

    // Variables Etat
    const state = { streets: {}, nego: "Alexis", gps: null, marker: null, timer: null, seconds: 0 };

    // --- FONCTIONS CL√âS ---

    // A. Dessiner les zones (Fond tr√®s discret)
    ZONES.forEach(z => {
      L.polygon(z.poly, { color: z.color, stroke: false, fillOpacity: 0.05, interactive: false }).addTo(map);
    });

    // B. D√©terminer la couleur (R√®gle des 20 jours)
    function getStatusColor(date) {
      if(!date) return "#ff3b30"; // ROUGE (Jamais)
      const diff = (new Date() - new Date(date)) / (1000 * 3600 * 24);
      if(diff <= 20) return "#2ecc71"; // VERT (Fait < 20j)
      return "#f39c12"; // ORANGE (A refaire)
    }

    // C. Dessiner une rue
    function drawStreet(name, latlngs, lastDate) {
      if(state.streets[name]) return; // Eviter doublons

      // 1. Calculer le secteur (Turf)
      let zoneId = "Hors Zone";
      try {
        const center = latlngs[Math.floor(latlngs.length/2)];
        const pt = turf.point([center[1], center[0]]); // Lon, Lat
        const found = ZONES.find(z => {
             // Conversion polygone pour Turf
             const polyCoords = z.poly.map(p => [p[1], p[0]]); // [Lon, Lat]
             polyCoords.push(polyCoords[0]); // Fermer la boucle
             return turf.booleanPointInPolygon(pt, turf.polygon([polyCoords]));
        });
        if(found) zoneId = found.id;
      } catch(e){}

      const color = getStatusColor(lastDate);

      // 2. Layer INVISIBLE (Large pour le clic)
      const hitLine = L.polyline(latlngs, { weight: 20, opacity: 0 }).addTo(map);

      // 3. Layer VISIBLE (Fin et color√©)
      const visLine = L.polyline(latlngs, { 
        color: color, weight: 4, opacity: 0.8, interactive: false 
      }).addTo(map);

      // 4. Interaction
      hitLine.on('click', (e) => {
         // Zoom automatique
         map.fitBounds(hitLine.getBounds(), { padding: [50, 50], maxZoom: 18 });
         
         // Popup
         const safeName = name.replace(/'/g, "\\'");
         const dateStr = lastDate ? new Date(lastDate).toLocaleDateString() : "Jamais";
         
         const popupHtml = `
            <span class="street-name">${name}</span>
            <span class="street-meta">Secteur ${zoneId} ‚Ä¢ ${dateStr}</span>
            <button class="btn-validate" onclick="validate('${safeName}', ${zoneId})">‚úÖ MARQUER FAIT</button>
            <button class="btn-view" onclick="streetView(${e.latlng.lat}, ${e.latlng.lng})">üëÅÔ∏è STREET VIEW</button>
         `;
         L.popup({offset:[0,-10]}).setLatLng(e.latlng).setContent(popupHtml).openOn(map);
      });

      state.streets[name] = { vis: visLine, hit: hitLine, zoneId: zoneId, date: lastDate };
    }

    // --- LOGIQUE GLOBALE ---

    window.validate = async (name, zoneId) => {
        const today = new Date().toISOString().split('T')[0];
        if(state.streets[name]) {
            state.streets[name].vis.setStyle({ color: '#2ecc71' });
            state.streets[name].date = today;
        }
        map.closePopup();
        updateUI();
        if(supabaseClient) {
            await supabaseClient.from('street_passages').upsert({
                street_name: name, passage_date: today, negociateur: state.nego, zone_id: zoneId
            }, { onConflict: 'street_name' });
        }
    };

    window.streetView = (lat, lng) => {
        window.open(`https://www.google.com/maps?layer=c&cbll=${lat},${lng}`, '_blank');
    };

    function updateUI() {
        const myZoneId = ZONES.find(z => z.nego === state.nego)?.id;
        let count = 0;
        
        Object.values(state.streets).forEach(st => {
            const isMine = (st.zoneId === myZoneId);
            // Opacit√© : 1 si c'est mon secteur, 0.2 sinon
            st.vis.setStyle({ opacity: isMine ? 1 : 0.2, weight: isMine ? 4 : 2 });
            if(isMine) st.hit.bringToFront(); // Priorit√© au clic

            if(isMine && st.date && (new Date() - new Date(st.date))/(8.64e7) <= 20) count++;
        });
        document.getElementById('coverage').innerText = `${count} rues faites (20j)`;
    }

    // --- CHARGEMENT AUTOMATIQUE DES VRAIES RUES ---
    async function autoLoadStreets() {
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        // On r√©cup√®re d'abord l'historique
        let history = {};
        if(supabaseClient) {
            const { data } = await supabaseClient.from('street_passages').select('*');
            if(data) data.forEach(d => history[d.street_name] = d.passage_date);
        }

        // Requ√™te Overpass API (Zone LARGE autour de St Andr√©)
        // Bbox: sud, ouest, nord, est
        const query = `[out:json][timeout:25];
            way["highway"~"residential|unclassified|living_street"](44.95,-0.50,45.05,-0.38);
            out geom;`;
            
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
            const data = await res.json();
            
            data.elements.forEach(el => {
                if(el.tags && el.tags.name) {
                    const latlngs = el.geometry.map(p => [p.lat, p.lon]);
                    drawStreet(el.tags.name, latlngs, history[el.tags.name]);
                }
            });
            updateUI();
            loader.style.display = 'none';
        } catch(e) {
            loader.innerText = "Erreur r√©seau (r√©essayer)";
            console.error(e);
        }
    }

    // --- EVENTS ---
    
    // Changement N√©gociateur
    document.getElementById('negociateur').addEventListener('change', (e) => {
        state.nego = e.target.value;
        updateUI();
    });

    // Bouton Start / Stop
    document.getElementById('btnStart').addEventListener('click', function() {
        if(state.timer) {
            clearInterval(state.timer); state.timer = null;
            this.innerText = "‚ñ∂ GO"; this.style.background = "#000";
        } else {
            state.seconds = 0;
            state.timer = setInterval(() => {
                state.seconds++;
                const d = new Date(state.seconds * 1000).toISOString().substr(11, 8);
                document.getElementById('timer').innerText = d;
            }, 1000);
            this.innerText = "‚èπ STOP"; this.style.background = "#ff3b30";
        }
    });

    // Bouton GPS
    document.getElementById('btnGps').addEventListener('click', () => {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const ll = [pos.coords.latitude, pos.coords.longitude];
                map.setView(ll, 16);
                if(!state.marker) state.marker = L.circleMarker(ll, {radius:8, color:'white', fillColor:'#007AFF', fillOpacity:1}).addTo(map);
                else state.marker.setLatLng(ll);
            });
        }
    });

    // Appui long pour Street View (Simulation)
    let pressTimer;
    map.on('mousedown touchstart', (e) => {
        pressTimer = setTimeout(() => streetView(e.latlng.lat, e.latlng.lng), 800);
    });
    map.on('mouseup touchend mousemove touchmove', () => clearTimeout(pressTimer));

    // LANCEMENT
    autoLoadStreets();

  </script>
</body>
</html>
