<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mansion V24 - Unlocked</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #F4F4F6; --card: rgba(255, 255, 255, 0.98); --text: #1C1C1E;
      --primary: #000; --accent: #007AFF; --success: #34C759; --danger: #FF3B30;
      --shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    /* RESET TACTILE TOTAL */
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      user-select: none; 
      -webkit-user-select: none; 
      touch-action: none; 
    }
    input, textarea { 
      user-select: text; 
      -webkit-user-select: text; 
      touch-action: auto; 
    }

    body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); overflow: hidden; color: var(--text); }

    /* MAP */
    #map { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; z-index: 1; }
    body.sat-mode #map { filter: none !important; }

    /* HEADER */
    header {
      position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
      background: var(--card); padding: 10px 20px;
      border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
      box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center;
    }
    .user-select { background: rgba(120,120,128,0.1); padding: 6px 12px; border-radius: 20px; font-weight: 700; display: flex; gap: 8px; align-items: center; font-size: 13px; }
    select { background: transparent; border: none; font-weight: 700; color: var(--text); outline: none; font-size: 13px; }
    .obj-counter { font-weight: 800; font-size: 14px; }

    /* WIDGETS */
    .widgets { position: absolute; right: 15px; top: 80px; z-index: 900; display: flex; flex-direction: column; gap: 15px; align-items: flex-end; }
    .fab { width: 44px; height: 44px; border-radius: 50%; background: var(--card); color: var(--text); border: none; box-shadow: var(--shadow); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    /* Etats Actifs */
    .gps-active { color: var(--accent); border: 2px solid var(--accent); }
    .sat-active { border: 2px solid var(--success); color: var(--success); }
    .cad-active { background: #FF9500; color: white; border: none; }
    .dvf-active { background: #5856D6; color: white; border: none; }

    /* TOUR MENU */
    .tour-container { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
    .tour-timer-badge { background: var(--primary); color: var(--bg); padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 800; display: none; margin-bottom: 5px; box-shadow: var(--shadow); animation: pulseRed 2s infinite; }
    @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(255, 59, 48, 0); } }
    .tour-controls { display: none; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 30px; backdrop-filter: blur(5px); }
    .tour-controls.visible { display: flex; }
    .btn-stop { background: var(--danger); color: white; }

    /* BOTTOM SHEET */
    #sheet { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1100; background: var(--card); border-top-left-radius: 32px; border-top-right-radius: 32px; padding: 20px 20px 30px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); }
    #sheet.open { transform: translateY(0); }
    .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .st-name { font-size: 18px; font-weight: 800; line-height: 1.1; max-width: 80%; }
    .close-sheet { background: rgba(120,120,128,0.1); width: 28px; height: 28px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; }

    /* QUICK ACTIONS */
    .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
    .q-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; background: rgba(120,120,128,0.05); border: 1px solid rgba(120,120,128,0.1); border-radius: 12px; padding: 12px 5px; cursor: pointer; transition: 0.2s; }
    .q-btn:active { background: var(--text); color: var(--bg); }
    .btn-main { width: 100%; padding: 16px; border-radius: 18px; background: var(--success); color: white; border: none; font-weight: 800; font-size: 16px; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

    /* WIZARD */
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 5000; display:none; align-items:flex-end; justify-content:center; backdrop-filter: blur(5px); }
    .wizard-card { background: var(--bg); width: 100%; max-width: 400px; padding: 25px; border-top-left-radius: 30px; border-top-right-radius: 30px; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
    .key { background: var(--card); padding: 15px; border-radius: 12px; border: none; font-size: 20px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
    .num-display { width: 100%; padding: 15px; font-size: 24px; text-align: center; font-weight: 800; background: rgba(0,0,0,0.05); border-radius: 12px; margin-bottom: 15px; border: none; }

    .form-group { margin-bottom: 10px; }
    .form-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(120,120,128,0.2); font-size: 16px; background: var(--card); }
    textarea.form-input { min-height: 80px; font-family: inherit; resize: none; }
    .radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
    .radio-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ccc; background: transparent; font-weight: 600; cursor: pointer; }
    .radio-btn.selected { background: var(--text); color: var(--bg); border-color: var(--text); }

    /* STREET VIEW PIN (remplace le cercle) */
    #touch-ring {
      position: absolute;
      width: 32px;
      height: 32px;
      transform: translate(-50%, -100%);
      font-size: 28px;
      line-height: 32px;
      text-align: center;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }
    #touch-ring.active { display: block; }
    #touch-ring .fill { display: none; } /* plus d‚Äôanimation cercle */

    /* DVF MARKER */
    .dvf-marker { 
        background: #5856D6; color: white; border-radius: 8px; padding: 4px 8px; 
        font-size: 11px; font-weight: 800; white-space: nowrap; border: 2px solid white; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.3); text-align:center; width: auto !important; height: auto !important;
    }

    /* MARQUEUR POSITION UTILISATEUR */
    .me-marker {
      font-size: 24px;
      transform: translate(-50%, -100%);
    }

    /* UTILS */
    .toast { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: var(--primary); color: var(--bg); padding: 10px 20px; border-radius: 30px; font-weight: 700; font-size: 13px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
    .toast.show { opacity: 1; margin-top: 10px; }
    
    /* LOADER AVEC TIMER DE SECURITE */
    #loader { position: absolute; bottom: 50%; left: 50%; transform: translate(-50%, 50%); background: var(--card); padding: 15px 30px; border-radius: 50px; font-weight: 800; z-index: 3000; box-shadow: var(--shadow); }

  </style>
</head>
<body>

  <header>
    <div class="user-select">
      <span id="user-emoji">üëë</span>
      <select id="user-pick">
        <option value="Alexis">Alexis</option>
        <option value="Nicolas">Nicolas</option>
        <option value="Thibault">Thibault</option>
        <option value="Laurent">Laurent</option>
      </select>
    </div>
    <div class="obj-counter">üéØ <span id="daily-c">0</span>/10</div>
  </header>

  <div class="widgets">
    <div class="tour-container">
      <div id="chrono-badge" class="tour-timer-badge">00:00</div>
      <div class="tour-controls" id="tour-menu">
        <button class="fab btn-stop" onclick="endTour()">‚èπ</button>
        <button class="fab" onclick="pauseTour()">‚è∏</button>
      </div>
      <button class="fab" id="btn-tour-main" onclick="toggleTourMenu()">‚ñ∂Ô∏è</button>
    </div>

    <button class="fab" id="btn-cadastre" onclick="toggleCadastre()">üìê</button>
    <button class="fab" id="btn-dvf" onclick="toggleDVF()">üí∞</button>
    <button class="fab" id="btn-gps" onclick="toggleGPS()">üìç</button>
    <button class="fab" id="btn-sat" onclick="toggleSat()">üõ∞Ô∏è</button>
  </div>

  <div id="loader">Chargement...</div>
  <div id="toast" class="toast">Action enregistr√©e</div>
  
  <!-- Pin Street View -->
  <div id="touch-ring">üìç<div class="fill"></div></div>

  <div id="map"></div>

  <div id="sheet">
    <div class="sheet-header">
      <div class="st-name" id="st-name">Rue...</div>
      <button class="close-sheet" onclick="closeSheet()">‚úï</button>
    </div>
    <div class="quick-actions">
      <button class="q-btn" onclick="startWizard('‚õî Refus')"><span>‚õî</span><div>Refus</div></button>
      <button class="q-btn" onclick="startWizard('ü§ù Int√©ress√©')"><span>ü§ù</span><div>Int√©ress√©</div></button>
      <button class="q-btn" onclick="startWizard('üè† √Ä Vendre')"><span>üè†</span><div>Vente</div></button>
    </div>
    <button class="btn-main" onclick="validateBoitage()">üì¨ BO√éTAGE FAIT</button>
  </div>

  <!-- WIZARD CONTACT -->
  <div id="wizard-modal" class="modal-overlay">
    <div class="wizard-card" id="step-1">
      <div class="wiz-title">Num√©ro de rue ?</div>
      <input type="text" id="wiz-num" class="num-display" placeholder="N¬∞" readonly>
      <div class="keypad">
        <button class="key" onclick="kp('1')">1</button>
        <button class="key" onclick="kp('2')">2</button>
        <button class="key" onclick="kp('3')">3</button>
        <button class="key" onclick="kp('4')">4</button>
        <button class="key" onclick="kp('5')">5</button>
        <button class="key" onclick="kp('6')">6</button>
        <button class="key" onclick="kp('7')">7</button>
        <button class="key" onclick="kp('8')">8</button>
        <button class="key" onclick="kp('9')">9</button>
        <button class="key" style="background:#eee" onclick="kp('C')">C</button>
        <button class="key" onclick="kp('0')">0</button>
        <button class="key" style="background:var(--success); color:white" onclick="nextStep()">OK</button>
      </div>
      <button onclick="closeWizard()" style="width:100%; padding:10px; background:none; border:none; color:gray">Annuler</button>
    </div>

    <div class="wizard-card" id="step-2" style="display:none">
      <div class="wiz-title">D√©tails & Note</div>
      <div class="radio-group">
        <button class="radio-btn selected" onclick="selCiv(this, 'M')">M.</button>
        <button class="radio-btn" onclick="selCiv(this, 'Mme')">Mme</button>
      </div>
      <div class="form-group"><input id="c-name" class="form-input" placeholder="Nom"></div>
      <div class="form-group"><input id="c-tel" class="form-input" type="tel" placeholder="T√©l√©phone"></div>
      <!-- Champ email ajout√© -->
      <div class="form-group"><input id="c-mail" class="form-input" type="email" placeholder="Email (optionnel)"></div>
      <div class="form-group">
        <textarea id="c-note" class="form-input" placeholder="üìù Note importante..."></textarea>
      </div>
      <button class="btn-main" onclick="finishWizard()">ENREGISTRER</button>
    </div>
  </div>

  <!-- FIN TOUR -->
  <div id="end-modal" class="modal-overlay">
    <div class="wizard-card" style="text-align:center">
      <div class="wiz-title">Fin de tourn√©e üéâ</div>
      <div style="font-size:30px; margin:20px 0" id="res-cal">0 kcal</div>
      <input type="number" id="res-fly" class="form-input" placeholder="Flyers distribu√©s ?" style="text-align:center">
      <button class="btn-main" style="margin-top:20px" onclick="saveTour()">VALIDER</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    const CENTER_LAT = 44.9945;
    const CENTER_LNG = -0.4465;
    const SB_URL = "https://wqujtckrvdhrwknplumq.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    const USERS = {
      "Alexis":   { w: 79, color: '#e74c3c', center: [45.005, -0.455], zone: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG-0.05], [CENTER_LAT, CENTER_LNG-0.05]] },
      "Nicolas":  { w: 90, color: '#3498db', center: [45.005, -0.435], zone: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG], [CENTER_LAT+0.05, CENTER_LNG+0.05], [CENTER_LAT, CENTER_LNG+0.05]] },
      "Thibault": { w: 72, color: '#f1c40f', center: [44.985, -0.455], zone: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG-0.05], [CENTER_LAT, CENTER_LNG-0.05]] },
      "Laurent":  { w: 75, color: '#9b59b6', center: [44.985, -0.435], zone: [[CENTER_LAT, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG], [CENTER_LAT-0.05, CENTER_LNG+0.05], [CENTER_LAT, CENTER_LNG+0.05]] }
    };
    const EMOJIS = { "Alexis": "üëë", "Nicolas": "üöÄ", "Thibault": "ü¶Å", "Laurent": "‚ö°" };
    const state = { streets: {}, nego: "Alexis", selected: null, daily: 0, tour: { active: false, paused: false, start: 0, int: null, dist: 0 }, wizard: { tag: '', num: '' }, layers: {} };

    // --- MAP INIT ---
    const map = L.map('map', { zoomControl: false, tap: false }).setView(USERS["Alexis"].center, 15);
    
    map.createPane('zonesPane'); map.getPane('zonesPane').style.zIndex = 350;
    map.createPane('cadastrePane'); map.getPane('cadastrePane').style.zIndex = 380; 
    map.createPane('streetsPane'); map.getPane('streetsPane').style.zIndex = 450;
    map.createPane('markersPane'); map.getPane('markersPane').style.zIndex = 650;

    const lPlan = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
    const lSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
    
    // CADASTRE IGN (URL corrig√©e)
    state.layers.cadastre = L.tileLayer.wms('https://data.geopf.fr/wms-r', {
        layers: 'CADASTRALPARCELS.PARCELLAIRE_EXPRESS',
        format: 'image/png',
        transparent: true,
        pane: 'cadastrePane',
        opacity: 0.7
    });
    
    state.layers.dvf = L.layerGroup(); // DVF

    const polyLayer = L.layerGroup().addTo(map);
    function drawZones() {
        polyLayer.clearLayers();
        Object.values(USERS).forEach(u => {
            L.polygon(u.zone, { color: u.color, weight: 1, fillOpacity: 0.1, interactive: false, pane: 'zonesPane' }).addTo(polyLayer);
        });
    }
    drawZones();

    // --- STREET DRAW ---
    function drawStreet(name, latlngs, dbData) {
        let color = "#ff3b30"; let opacity = 0.5; let weight = 3;
        if(dbData && dbData.method === 'boitage') {
            const diff = (new Date() - new Date(dbData.passage_date)) / 8.64e7;
            if(diff <= 20) { color = "#34C759"; opacity = 0.8; }
            else color = "#FF9500";
        }
        const vis = L.polyline(latlngs, { color: color, weight: weight, opacity: opacity, interactive: false, pane: 'streetsPane' }).addTo(map);
        const hit = L.polyline(latlngs, { weight: 25, opacity: 0 }).addTo(map);
        state.streets[name] = { vis, hit, dbData, defColor: color, defOp: opacity };
        hit.on('click', (e) => { L.DomEvent.stopPropagation(e); selectStreet(name); });
    }

    function selectStreet(name) {
        if(state.selected && state.streets[state.selected]) {
            const old = state.streets[state.selected];
            old.vis.setStyle({ color: old.defColor, weight: 3, opacity: old.defOp });
        }
        state.selected = name;
        const st = state.streets[name];
        st.vis.setStyle({ color: '#007AFF', weight: 6, opacity: 1 });
        st.vis.bringToFront();
        map.fitBounds(st.vis.getBounds(), { paddingBottomRight: [0, 200], maxZoom: 18, animate: true });
        document.getElementById('st-name').innerText = name;
        document.getElementById('sheet').classList.add('open');
    }

    window.closeSheet = () => {
        if(state.selected) {
            const st = state.streets[state.selected];
            st.vis.setStyle({ color: st.defColor, weight: 3, opacity: st.defOp });
            state.selected = null;
        }
        document.getElementById('sheet').classList.remove('open');
    };

    window.validateBoitage = async () => {
        const name = state.selected;
        if(!name) return;
        state.streets[name].vis.setStyle({ color: "#34C759", weight: 3, opacity: 0.8 });
        state.streets[name].defColor = "#34C759";
        state.daily++; document.getElementById('daily-c').innerText = state.daily;
        closeSheet();
        showToast("‚úÖ Bo√Ætage OK");
        const today = new Date().toISOString().split('T')[0];
        await supabaseClient.from('street_passages').upsert(
          { street_name: name, passage_date: today, negociateur: state.nego, method: 'boitage' },
          { onConflict: 'street_name' }
        );
    };

    // --- OUTILS ---
    window.toggleCadastre = () => {
        const btn = document.getElementById('btn-cadastre');
        if(map.hasLayer(state.layers.cadastre)) { 
          map.removeLayer(state.layers.cadastre); 
          btn.classList.remove('cad-active'); 
        }
        else { 
          map.addLayer(state.layers.cadastre); 
          btn.classList.add('cad-active'); 
          showToast("üìê Cadastre activ√©"); 
        }
    };

    window.toggleDVF = async () => {
        const btn = document.getElementById('btn-dvf');
        if(map.hasLayer(state.layers.dvf)) { 
          map.removeLayer(state.layers.dvf); 
          btn.classList.remove('dvf-active'); 
        } else { 
          btn.classList.add('dvf-active'); 
          showToast("üí∞ Chargement ventes (DVF)...");
          await loadDVFData();
          if(Object.keys(state.layers.dvf._layers).length === 0) {
            showToast("DVF ne peut pas √™tre charg√© directement (limitation API).");
          } else {
            map.addLayer(state.layers.dvf);
          }
        }
    };

    async function loadDVFData() {
        state.layers.dvf.clearLayers();
        const center = map.getCenter();
        try {
            // ATTENTION : cette API n'est pas officiellement utilisable c√¥t√© navigateur (CORS).
            const res = await fetch(`https://api-dvf.etalab.gouv.fr/api/mutations3/geocodage?lat=${center.lat}&lon=${center.lng}&dist=500`);
            if(!res.ok) throw new Error("HTTP " + res.status);
            const json = await res.json();
            if(json.features && json.features.length > 0) {
                json.features.forEach(f => {
                    const p = f.properties;
                    if(!p.valeur_fonciere) return;
                    const prix = Math.round(p.valeur_fonciere/1000) + "k";
                    const icon = L.divIcon({ className: 'dvf-marker', html: prix, iconSize: [40, 20] });
                    L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {icon: icon, pane:'markersPane'}).addTo(state.layers.dvf);
                });
                showToast(`${json.features.length} ventes trouv√©es`);
            } else {
                showToast("Aucune vente DVF trouv√©e ici");
            }
        } catch(e) { 
            console.error("DVF error", e); 
            showToast("Erreur DVF / CORS (voir console).");
        }
    }

    // --- STREET VIEW (LONG PRESS, PIN) ---
    const mapEl = document.getElementById('map');
    const ring = document.getElementById('touch-ring');
    let pressTimer = null;
    let isReady = false;

    window.oncontextmenu = (e) => { e.preventDefault(); return false; };

    mapEl.addEventListener('touchstart', (e) => {
        if(e.touches.length > 1) return; 
        const t = e.touches[0];
        const x = t.clientX; const y = t.clientY;
        isReady = false;
        
        ring.style.left = x + 'px'; 
        ring.style.top = (y - 40) + 'px';
        ring.classList.remove('success'); 
        ring.classList.add('active');

        pressTimer = setTimeout(() => {
            isReady = true; 
            if(navigator.vibrate) navigator.vibrate(50);
        }, 800);
    }, {passive: false});

    mapEl.addEventListener('touchmove', () => { 
        clearTimeout(pressTimer); 
        ring.classList.remove('active'); 
        isReady = false; 
    }, {passive: false});

    mapEl.addEventListener('touchend', (e) => {
        clearTimeout(pressTimer); 
        ring.classList.remove('active');
        if(isReady) {
            const t = e.changedTouches[0];
            const pt = L.point(t.clientX, t.clientY);
            const ll = map.containerPointToLatLng(pt);
            // URL corrig√©e (plus de "$$")
            window.open(`https://www.google.com/maps/search/?api=1&query=${ll.lat},${ll.lng}`, '_blank');
        }
        isReady = false;
    });

    // --- WIZARD ---
    window.startWizard = (tag) => {
        state.wizard = { tag, num: '' };
        document.getElementById('wiz-num').value = '';
        document.getElementById('c-name').value = '';
        document.getElementById('c-tel').value = '';
        document.getElementById('c-mail').value = '';
        document.getElementById('c-note').value = '';
        document.getElementById('step-1').style.display = 'block';
        document.getElementById('step-2').style.display = 'none';
        document.getElementById('wizard-modal').style.display = 'flex';
    };
    window.kp = (k) => { 
      if(k==='C') state.wizard.num=''; 
      else state.wizard.num+=k; 
      document.getElementById('wiz-num').value = state.wizard.num; 
    };
    
    window.nextStep = () => {
        if(!state.wizard.num) return alert("Num√©ro requis");
        document.getElementById('step-1').style.display='none';
        document.getElementById('step-2').style.display='block';
    };
    window.selCiv = (el,v) => { 
      document.querySelectorAll('.radio-btn').forEach(b=>b.classList.remove('selected')); 
      el.classList.add('selected'); 
      state.wizard.civ=v; 
    };
    
    window.finishWizard = async () => {
        state.wizard.contact = { 
            nom: document.getElementById('c-name').value, 
            tel: document.getElementById('c-tel').value, 
            mail: document.getElementById('c-mail').value, 
            note: document.getElementById('c-note').value, 
            civ: state.wizard.civ||'M' 
        };
        await saveHistory(); 
        closeWizard();
    };
    
    async function saveHistory() {
        await supabaseClient.from('street_history').insert({
          street_name: state.selected, 
          action_type: state.wizard.tag, 
          action_data: { num: state.wizard.num, contact: state.wizard.contact }, 
          negociateur: state.nego 
        });
        showToast("Note enregistr√©e !");
    }
    window.closeWizard = () => document.getElementById('wizard-modal').style.display='none';

    function showToast(m) { 
      const t=document.getElementById('toast'); 
      t.innerText=m; 
      t.classList.add('show'); 
      setTimeout(()=>t.classList.remove('show'),2000); 
    }

    // --- TOURNEE & GPS ---
    window.toggleTourMenu = () => {
        if(!state.tour.active) {
            state.tour.active = true; 
            state.tour.paused = false; 
            state.tour.start = Date.now();
            document.getElementById('btn-tour-main').innerText = "‚è±Ô∏è";
            document.getElementById('chrono-badge').style.display = 'block';
            activateGPS();
            state.tour.int = setInterval(() => {
                if(state.tour.paused) return;
                const sec = Math.floor((Date.now() - state.tour.start) / 1000);
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                document.getElementById('chrono-badge').innerText = `${m}:${s}`;
            }, 1000);
        } else { 
          document.getElementById('tour-menu').classList.toggle('visible'); 
        }
    };
    window.pauseTour = () => { 
      state.tour.paused = !state.tour.paused; 
      document.getElementById('chrono-badge').style.opacity = state.tour.paused ? 0.5 : 1; 
      document.getElementById('tour-menu').classList.remove('visible'); 
    };
    window.endTour = () => { 
      clearInterval(state.tour.int); 
      state.tour.active = false; 
      const km = state.tour.dist; 
      const cal = Math.round(km * USERS[state.nego].w * 0.75); 
      document.getElementById('res-cal').innerText = cal + " kcal"; 
      document.getElementById('end-modal').style.display = 'flex'; 
    };
    window.saveTour = async () => { 
      const qty = document.getElementById('res-fly').value; 
      await supabaseClient.from('tours').insert({ 
        negociateur: state.nego, 
        duration: document.getElementById('chrono-badge').innerText, 
        flyers_count: qty, 
        distance_km: state.tour.dist.toFixed(2), 
        calories: parseInt(document.getElementById('res-cal').innerText) 
      }); 
      location.reload(); 
    };

    function activateGPS() {
        if(!navigator.geolocation) return;
        document.getElementById('btn-gps').classList.add('gps-active');
        state.gps = navigator.geolocation.watchPosition(pos => {
            const ll = [pos.coords.latitude, pos.coords.longitude];
            if(!state.me) {
                const meIcon = L.divIcon({
                  className: 'me-marker',
                  html: 'üìç',
                  iconSize: [24, 24],
                  iconAnchor: [12, 24]
                });
                state.me = L.marker(ll, { icon: meIcon, pane:'markersPane' }).addTo(map);
                map.setView(ll,17);
            } else state.me.setLatLng(ll);

            if(state.tour.active && !state.tour.paused && state.tour.last) {
              state.tour.dist += turf.distance(
                turf.point(state.tour.last), 
                turf.point([ll[1], ll[0]])
              );
            }
            state.tour.last = [ll[1], ll[0]];
        }, null, {enableHighAccuracy:true});
    }
    window.toggleGPS = () => { 
      if(state.gps) { 
        navigator.geolocation.clearWatch(state.gps); 
        state.gps=null; 
        document.getElementById('btn-gps').classList.remove('gps-active'); 
      } else activateGPS(); 
    };

    // --- INIT ---
    async function init() {
        setTimeout(() => document.getElementById('loader').style.display='none', 3000);

        let hist = {};
        try {
          const { data } = await supabaseClient.from('street_passages').select('*');
          if(data) data.forEach(d => hist[d.street_name] = d);
        } catch(e) {
          console.error("Supabase error", e);
        }

        const q = `[out:json][timeout:90];
          way["highway"~"residential|unclassified|living_street|tertiary|secondary|primary|service|track|pedestrian"](44.96,-0.50,45.04,-0.40);
          out geom;`;
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q));
            const json = await res.json();
            json.elements.forEach(el => { 
              if(el.tags && el.tags.name) 
                drawStreet(el.tags.name, el.geometry.map(p=>[p.lat,p.lon]), hist[el.tags.name]); 
            });
        } catch(e) { console.error(e); }
        document.getElementById('loader').style.display='none';
    }

    window.toggleSat = () => { 
      state.sat=!state.sat; 
      const btn = document.getElementById('btn-sat'); 
      if(state.sat) { 
        map.removeLayer(lPlan); 
        map.addLayer(lSat); 
        document.body.classList.add('sat-mode'); 
        btn.classList.add('sat-active'); 
      } else { 
        map.removeLayer(lSat); 
        map.addLayer(lPlan); 
        document.body.classList.remove('sat-mode'); 
        btn.classList.remove('sat-active'); 
      } 
    };

    document.getElementById('user-pick').addEventListener('change', (e) => { 
      state.nego = e.target.value; 
      document.getElementById('user-emoji').innerText = EMOJIS[state.nego] || 'üë§';
      map.flyTo(USERS[state.nego].center, 15, { duration: 1 }); 
    });
    
    init();
  </script>
</body>
</html>
