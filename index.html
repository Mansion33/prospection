<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte Mansion - Version Robuste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; background: #f5f5f5; overflow: hidden; }
    * { box-sizing: border-box; }

    /* Header & Controls */
    header { background: #fff; padding: 10px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; height: 60px; }
    .brand { font-weight: bold; font-size: 14px; }
    .controls { display: flex; gap: 5px; }
    select, button { padding: 5px; border-radius: 4px; border: 1px solid #999; font-size: 12px; background: white; }
    button.primary { background: black; color: white; border-color: black; }

    /* Dashboard */
    #dashboard { background: white; padding: 10px; font-size: 12px; height: 140px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 5px; }
    .stats { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: #555; }
    .inputs { display: flex; gap: 5px; }
    .inputs input, .inputs textarea { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    
    /* Map */
    #map { width: 100%; height: calc(100vh - 200px); background: #e5e5e5; z-index: 1; }

    /* Loader */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: white; z-index: 9999; display: flex; justify-content: center; align-items: center;
      transition: opacity 0.5s;
    }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid #000; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .hidden { opacity: 0; pointer-events: none; }

    /* Styles Popup */
    .popup-content { text-align: center; min-width: 150px; }
    .btn-done { background: #2ecc71; color: white; border: none; padding: 8px; width: 100%; margin-top: 5px; cursor: pointer; border-radius: 4px; }
  </style>
</head>
<body>

  <div id="loader">
    <div style="text-align:center">
      <div class="spinner" style="margin:0 auto 10px auto"></div>
      <div>Chargement carte...</div>
      <small style="color:#999; margin-top:5px; display:block;">(Force l'ouverture dans 2s)</small>
    </div>
  </div>

  <header>
    <div class="brand">Mansion Prospection</div>
    <div class="controls">
      <select id="negociateur">
        <option value="Alexis">Alexis (NO)</option>
        <option value="Nicolas">Nicolas (NE)</option>
        <option value="Thibault">Thibault (SO)</option>
        <option value="Laurent">Laurent (SE)</option>
      </select>
      <button id="btnGps">üìç GPS</button>
      <button id="btnLoad">‚ûï Rues</button>
    </div>
  </header>

  <div id="dashboard">
    <div class="stats">
      <span id="timer">00:00:00</span>
      <span id="coverage">0% Couvert</span>
    </div>
    <div class="inputs">
      <input type="number" id="flyers" placeholder="Nb Flyers">
      <textarea id="notes" placeholder="Notes..."></textarea>
    </div>
    <div style="margin-top:5px; display:flex; gap:5px;">
      <button id="btnStart" class="primary" style="flex:1;">‚ñ∂ D√©marrer</button>
      <button id="btnSave" disabled style="flex:1; background:#eee;">üíæ Sauver</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- S√âCURIT√â ANTI-CHARGEMENT INFINI ---
    // Si dans 2 secondes la carte n'est pas pr√™te, on vire le loader de force.
    setTimeout(() => {
        const loader = document.getElementById('loader');
        if(loader && !loader.classList.contains('hidden')) {
            console.warn("Force loader removal");
            loader.classList.add('hidden');
        }
    }, 2000);

    // --- CONFIGURATION ---
    const map = L.map('map').setView([44.996, -0.446], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    const ZONES = [
        { id:1, nego:"Alexis", color:"#e74c3c", poly:[[-0.48,45.02],[-0.446,45.02],[-0.446,44.995],[-0.48,44.995]] },
        { id:2, nego:"Nicolas", color:"#3498db", poly:[[-0.446,45.02],[-0.41,45.02],[-0.41,44.995],[-0.446,44.995]] },
        { id:3, nego:"Thibault", color:"#f1c40f", poly:[[-0.48,44.995],[-0.446,44.995],[-0.446,44.96],[-0.48,44.96]] },
        { id:4, nego:"Laurent", color:"#9b59b6", poly:[[-0.446,44.995],[-0.41,44.995],[-0.41,44.96],[-0.446,44.96]] }
    ];

    // Rues "Hard-cod√©es" pour garantir l'affichage imm√©diat
    const BASE_STREETS = [
        {name:"Rue Nationale", pts:[[44.993,-0.445],[44.998,-0.446],[45.002,-0.447]]},
        {name:"Route de Libourne", pts:[[44.993,-0.445],[44.990,-0.440],[44.985,-0.430]]},
        {name:"Rue de la Gare", pts:[[44.995,-0.446],[44.996,-0.450],[44.997,-0.455]]},
        {name:"Av. de l'Europe", pts:[[45.000,-0.440],[45.005,-0.435]]},
        {name:"Rue Dantagnan", pts:[[44.994,-0.448],[44.994,-0.452]]},
        {name:"Chemin Bois Milon", pts:[[44.985,-0.445],[44.980,-0.445]]},
        {name:"Rue Cousteau", pts:[[44.998,-0.442],[45.000,-0.438]]}
    ];

    let supabaseClient = null;
    const SUPABASE_URL = "https://wqujtckrvdhrwknplumq.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";

    const state = { nego: "Alexis", streets: {}, running: false, timer: null, start: 0 };

    // --- LOGIQUE PRINCIPALE ---
    async function startApp() {
        try {
            // 1. Setup Supabase (Sans bloquer si √ßa √©choue)
            if(typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                console.error("Supabase script failed to load");
            }

            // 2. Dessin des Zones
            ZONES.forEach(z => {
                // Inversion lat/lng pour Leaflet
                const poly = z.poly.map(p => [p[1], p[0]]);
                L.polygon(poly, { color: z.color, fillOpacity: 0.05, weight: 1, dashArray: '4' }).addTo(map);
            });

            // 3. R√©cup√©rer Historique
            let history = {};
            if(supabaseClient) {
                try {
                    const { data } = await supabaseClient.from('street_passages').select('*');
                    if(data) data.forEach(d => history[d.street_name] = d);
                } catch(e) { console.warn("Mode hors ligne (Supabase error)"); }
            }

            // 4. Dessin des Rues
            BASE_STREETS.forEach(s => drawStreet(s.name, s.pts, history[s.name]));

            // 5. Fin chargement (Normal)
            document.getElementById('loader').classList.add('hidden');
            updateUI();

        } catch (err) {
            alert("Erreur critique: " + err.message);
            document.getElementById('loader').classList.add('hidden');
        }
    }

    function drawStreet(name, coords, histData) {
        // Calcul simple couleur
        let color = "#bdc3c7"; // Gris
        let lastDate = histData ? histData.passage_date : null;
        
        if(lastDate) {
            const days = (new Date() - new Date(lastDate)) / (1000 * 3600 * 24);
            if(days <= 20) color = "#2ecc71"; // Vert
            else if(days <= 45) color = "#f39c12"; // Orange
            else color = "#e74c3c"; // Rouge
        }

        // Zone approximative (Turf)
        let zoneId = "?";
        try {
            const center = coords[Math.floor(coords.length/2)];
            const pt = turf.point([center[1], center[0]]); // lon, lat
            const z = ZONES.find(z => turf.booleanPointInPolygon(pt, turf.polygon([z.poly])));
            if(z) zoneId = z.id;
        } catch(e) {}

        // 1. Ligne Cliquable (Invisible mais large)
        L.polyline(coords, { weight: 25, opacity: 0 }).addTo(map).on('click', (e) => {
            const safeName = name.replace(/'/g, "\\'");
            const content = `
                <div class="popup-content">
                    <b>${name}</b><br>
                    <small>Zone ${zoneId}</small><br>
                    <small>Dernier: ${lastDate || "Jamais"}</small>
                    <button class="btn-done" onclick="doStreet('${safeName}', ${zoneId})">‚úÖ FAIT</button>
                </div>
            `;
            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
        });

        // 2. Ligne Visuelle
        const layer = L.polyline(coords, { color: color, weight: 4, interactive: false }).addTo(map);
        state.streets[name] = { layer, zoneId, date: lastDate };
    }

    window.doStreet = async (name, zoneId) => {
        const today = new Date().toISOString().split('T')[0];
        if(state.streets[name]) {
            state.streets[name].layer.setStyle({ color: "#2ecc71" });
            state.streets[name].date = today;
        }
        map.closePopup();
        updateUI();

        if(supabaseClient) {
            await supabaseClient.from('street_passages').upsert({
                street_name: name, passage_date: today, negociateur: state.nego, zone_id: zoneId
            }, { onConflict: 'street_name' });
        }
    };

    function updateUI() {
        const myZone = ZONES.find(z => z.nego === state.nego)?.id;
        
        // Update Opacity Rues
        Object.values(state.streets).forEach(st => {
            const isActive = (st.zoneId === myZone);
            st.layer.setStyle({ opacity: isActive ? 1 : 0.2, weight: isActive ? 4 : 2 });
        });

        // Stats
        const streets = Object.values(state.streets).filter(s => s.zoneId === myZone);
        if(streets.length) {
            const done = streets.filter(s => s.date && (new Date() - new Date(s.date))/(8.64e7) <= 20).length;
            const pct = Math.round((done / streets.length) * 100);
            document.getElementById('coverage').innerText = `${pct}% (${done}/${streets.length})`;
        } else {
            document.getElementById('coverage').innerText = "Hors Zone";
        }
    }

    // --- BOUTONS ---
    document.getElementById('negociateur').addEventListener('change', (e) => {
        state.nego = e.target.value;
        updateUI();
    });

    document.getElementById('btnLoad').addEventListener('click', async () => {
        const btn = document.getElementById('btnLoad');
        btn.innerText = "‚è≥";
        try {
            // Appel Overpass Simple
            const q = `[out:json][timeout:10];way["highway"~"residential|unclassified"](44.98,-0.46,45.01,-0.43);out geom;`;
            const res = await fetch("https://overpass-api.de/api/interpreter?data="+encodeURIComponent(q));
            const data = await res.json();
            let count = 0;
            data.elements.forEach(el => {
                if(el.tags && el.tags.name) {
                    const pts = el.geometry.map(p => [p.lat, p.lon]);
                    if(!state.streets[el.tags.name]) {
                        drawStreet(el.tags.name, pts, null);
                        count++;
                    }
                }
            });
            alert(count + " rues ajout√©es");
            updateUI();
        } catch(e) { alert("Erreur t√©l√©chargement"); }
        btn.innerText = "‚ûï Rues";
    });

    // Start Timer / Save logic would go here (simplified for space)
    
    // Lancement
    startApp();
  </script>
</body>
</html>
