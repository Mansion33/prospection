<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mansion V10 - Platinum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #F4F4F6; --card: rgba(255, 255, 255, 0.98); --text: #1C1C1E;
      --primary: #000; --accent: #007AFF; --success: #34C759; --danger: #FF3B30;
      --shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    body.dark { --bg: #000; --card: rgba(28, 28, 30, 0.98); --text: #FFF; --primary: #FFF; }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); overflow: hidden; color: var(--text); }

    /* MAP */
    #map { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; z-index: 1; transition: filter 0.3s; }
    body.dark #map { filter: invert(1) hue-rotate(180deg) brightness(0.6) contrast(1.1); }

    /* HEADER */
    header {
      position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
      background: var(--card); padding: 15px 20px 10px;
      border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
      box-shadow: var(--shadow); backdrop-filter: blur(20px);
    }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .brand { font-weight: 900; font-size: 20px; }
    .theme-toggle { background:none; border:none; font-size: 20px; cursor:pointer; }
    
    .user-row { display: flex; align-items: center; justify-content: space-between; }
    .user-select { background: rgba(120,120,128,0.1); padding: 6px 12px; border-radius: 20px; font-weight: 700; display: flex; gap: 8px; align-items: center; }
    select { background: transparent; border: none; font-weight: 700; color: var(--text); outline: none; font-size: 14px; }

    /* TOUR BAR (CHRONO) */
    .tour-bar {
      position: absolute; top: 110px; left: 50%; transform: translateX(-50%); z-index: 900;
      background: var(--primary); color: var(--bg); padding: 8px 20px; border-radius: 30px;
      display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow);
      font-feature-settings: "tnum"; font-variant-numeric: tabular-nums;
      opacity: 0; pointer-events: none; transition: 0.3s;
    }
    .tour-bar.active { opacity: 1; pointer-events: auto; top: 120px; }
    .chrono { font-weight: 800; font-size: 16px; letter-spacing: 1px; min-width: 60px; }
    .tour-btn { background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .tour-stop { background: var(--danger); }

    /* WIDGETS */
    .widgets { position: absolute; right: 15px; top: 180px; z-index: 900; display: flex; flex-direction: column; gap: 12px; }
    .fab { width: 48px; height: 48px; border-radius: 50%; background: var(--card); color: var(--text); border: none; box-shadow: var(--shadow); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .gps-on { color: var(--accent); border: 2px solid var(--accent); }

    /* BOTTOM SHEET */
    #sheet {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 1100;
      background: var(--card); border-top-left-radius: 32px; border-top-right-radius: 32px;
      padding: 25px 20px 40px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }
    #sheet.open { transform: translateY(0); }
    
    .street-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .st-name { font-size: 20px; font-weight: 800; line-height: 1.1; margin-bottom: 5px; }
    .st-meta { font-size: 12px; font-weight: 600; opacity: 0.6; }
    .close-sheet { background: rgba(120,120,128,0.1); width: 30px; height: 30px; border-radius: 50%; border: none; color: var(--text); font-weight: bold; cursor: pointer; }

    /* TAGS RAPIDES */
    .quick-tags { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 20px; }
    .tag { padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(120,120,128,0.2); background: transparent; color: var(--text); font-size: 12px; font-weight: 700; white-space: nowrap; cursor: pointer; }
    .tag:active { background: var(--text); color: var(--bg); }

    /* ACTION BUTTON */
    .btn-main { width: 100%; padding: 16px; border-radius: 18px; background: var(--success); color: white; border: none; font-weight: 800; font-size: 16px; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
    
    /* MODAL FIN TOURNEE */
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 5000; display:none; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
    .modal { background: var(--card); width: 85%; max-width: 320px; padding: 25px; border-radius: 24px; text-align: center; }
    .stat-result { font-size: 30px; font-weight: 800; margin: 10px 0; }
    .input-qty { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid rgba(0,0,0,0.1); font-size: 18px; text-align: center; margin: 15px 0; font-weight: bold; }

  </style>
</head>
<body>

  <header>
    <div class="top-bar">
      <div class="brand">MANSION V10</div>
      <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
    </div>
    <div class="user-row">
      <div class="user-select">
        <span id="user-icon">üëë</span>
        <select id="user-pick">
          <option value="Alexis">Alexis</option>
          <option value="Nicolas">Nicolas</option>
          <option value="Thibault">Thibault</option>
          <option value="Laurent">Laurent</option>
        </select>
      </div>
      <button class="user-select" style="background:var(--text); color:var(--bg); border:none;" id="btn-start" onclick="toggleTour()">
        ‚ñ∂Ô∏è START
      </button>
    </div>
  </header>

  <div class="tour-bar" id="tour-bar">
    <span class="chrono" id="chrono">00:00</span>
    <button class="tour-btn" onclick="pauseTour()">‚è∏</button>
    <button class="tour-btn tour-stop" onclick="endTour()">‚èπ</button>
  </div>

  <div class="widgets">
    <button class="fab" id="btn-sat" onclick="toggleSat()">üõ∞Ô∏è</button>
    <button class="fab" id="btn-gps" onclick="centerGPS()">üìç</button>
  </div>

  <div id="map"></div>

  <div id="sheet">
    <div class="street-header">
      <div>
        <div class="st-name" id="st-name">Rue...</div>
        <div class="st-meta" id="st-meta">Jamais faite</div>
      </div>
      <button class="close-sheet" onclick="closeSheet()">‚úï</button>
    </div>

    <div style="font-size:11px; font-weight:700; color:var(--text); opacity:0.5; margin-bottom:8px">NOTE RAPIDE</div>
    <div class="quick-tags">
      <button class="tag" onclick="addTag('‚õî Refus')">‚õî Refus</button>
      <button class="tag" onclick="addTag('ü§ù Int√©ress√©')">ü§ù Int√©ress√©</button>
      <button class="tag" onclick="addTag('üè† √Ä Vendre')">üè† √Ä Vendre</button>
      <button class="tag" onclick="addTag('üê∂ Chien')">üê∂ Chien</button>
    </div>

    <button class="btn-main" onclick="validateStreet()">üì¨ BO√éTAGE FAIT</button>
  </div>

  <div id="modal-end" class="modal-overlay">
    <div class="modal">
      <h2>Tourn√©e Termin√©e !</h2>
      <div style="font-size:12px; color:#888">CALORIES ESTIM√âES</div>
      <div class="stat-result" id="cal-result">0 kcal</div>
      
      <div style="text-align:left; margin-top:20px; font-weight:700; font-size:13px">STOCK FLYERS</div>
      <input type="number" id="flyer-input" class="input-qty" placeholder="Quantit√© distibu√©e ?" inputmode="numeric">
      
      <button class="btn-main" onclick="saveTourData()">ENREGISTRER</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- 1. CONFIG & DATA ---
    const CENTER_LAT = 44.9945;
    const CENTER_LNG = -0.4465;
    const SB_URL = "https://wqujtckrvdhrwknplumq.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    // CONFIG UTILISATEURS (Poids pour calories + Zone pour centrage)
    const USERS = {
      "Alexis":   { w: 79, color: '#e74c3c', center: [45.005, -0.455] }, // Nord-Ouest
      "Nicolas":  { w: 90, color: '#3498db', center: [45.005, -0.435] }, // Nord-Est
      "Thibault": { w: 72, color: '#f1c40f', center: [44.985, -0.455] }, // Sud-Ouest
      "Laurent":  { w: 75, color: '#9b59b6', center: [44.985, -0.435] }  // Sud-Est (Default 75kg)
    };

    const EMOJIS = { "Alexis": "üëë", "Nicolas": "üöÄ", "Thibault": "ü¶Å", "Laurent": "‚ö°" };

    const state = { 
        streets: {}, nego: "Alexis", selected: null, 
        tour: { active: false, paused: false, startTime: 0, distance: 0, lastPos: null, timerId: null },
        satMode: false, gpsWatch: null, userMarker: null
    };

    // --- 2. MAP INIT ---
    const map = L.map('map', { zoomControl: false, tap: false }).setView(USERS["Alexis"].center, 15);
    
    // Layers
    const layerPlan = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
    const layerSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });

    // --- 3. LOGIQUE METIER ---

    // Dessin Rues
    function drawStreet(name, latlngs, dbData) {
        // Statut Couleur
        let color = "#ff4757"; let opacity = 0.6;
        if(dbData && dbData.method === 'boitage') {
            const diff = (new Date() - new Date(dbData.passage_date)) / 8.64e7;
            if(diff <= 20) { color = "#34C759"; opacity = 0.8; }
            else color = "#FF9500";
        }

        // Ligne Visuelle (Fine)
        const vis = L.polyline(latlngs, { color: color, weight: 3, opacity: opacity, interactive: false }).addTo(map);
        // Ligne Clic (Large)
        const hit = L.polyline(latlngs, { weight: 22, opacity: 0 }).addTo(map);

        state.streets[name] = { vis, hit, dbData, latlngs };

        hit.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            selectStreet(name);
        });
        hit.on('touchstart', (e) => L.DomEvent.stopPropagation(e));
    }

    // Zoom & Ouverture Fiche
    function selectStreet(name) {
        state.selected = name;
        const st = state.streets[name];
        
        // 1. Zoom Progressif (FlyTo) avec padding pour le bottom sheet
        map.fitBounds(st.vis.getBounds(), { 
            paddingBottomRight: [0, 300], // Laisse place au sheet
            paddingTopLeft: [20, 20],
            maxZoom: 18,
            duration: 1 
        });

        // 2. Remplir Sheet
        document.getElementById('st-name').innerText = name;
        if(st.dbData) {
            document.getElementById('st-meta').innerText = `Dernier: ${new Date(st.dbData.passage_date).toLocaleDateString()}`;
            document.getElementById('st-meta').style.color = st.vis.options.color;
        } else {
            document.getElementById('st-meta').innerText = "Jamais faite";
            document.getElementById('st-meta').style.color = "#ff4757";
        }

        document.getElementById('sheet').classList.add('open');
    }

    // Validation Boitage
    window.validateStreet = async () => {
        const name = state.selected;
        if(!name) return;
        
        state.streets[name].vis.setStyle({ color: '#34C759', opacity: 1, weight: 5 }); // Feedback
        setTimeout(() => state.streets[name].vis.setStyle({ weight: 3 }), 400);
        
        closeSheet();
        
        const today = new Date().toISOString().split('T')[0];
        await supabaseClient.from('street_passages').upsert({
            street_name: name, passage_date: today, negociateur: state.nego, method: 'boitage'
        }, { onConflict: 'street_name' });
    };

    // Note Rapide (Ing√©nieuse)
    window.addTag = async (tag) => {
        const name = state.selected;
        await supabaseClient.from('street_history').insert({
            street_name: name, action_type: 'tag', action_data: { note: tag }, negociateur: state.nego
        });
        alert(`Tag "${tag}" ajout√© !`);
    };

    window.closeSheet = () => document.getElementById('sheet').classList.remove('open');

    // --- 4. GPS & TOURNEE & CALORIES ---

    window.toggleTour = () => {
        if(state.tour.active) return; // D√©j√† actif
        
        // D√©marrage
        state.tour.active = true;
        state.tour.startTime = Date.now();
        state.tour.distance = 0;
        state.tour.lastPos = null;
        
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('tour-bar').classList.add('active');
        
        // Active GPS auto
        activateGPS();
        
        // Chrono
        state.tour.timerId = setInterval(() => {
            if(state.tour.paused) return;
            const diff = Date.now() - state.tour.startTime; // Simple chrono
            const d = new Date(diff);
            document.getElementById('chrono').innerText = d.toISOString().substr(11, 5);
        }, 1000);
    };

    window.pauseTour = () => {
        state.tour.paused = !state.tour.paused;
        const btn = document.querySelector('#tour-bar button');
        btn.innerText = state.tour.paused ? "‚ñ∂Ô∏è" : "‚è∏";
    };

    window.endTour = () => {
        clearInterval(state.tour.timerId);
        document.getElementById('modal-end').style.display = 'flex';
        
        // Calcul Calories : (Distance km * Poids * 0.75 coeff marche active)
        const km = state.tour.distance;
        const weight = USERS[state.nego]?.w || 75;
        const cals = Math.round(km * weight * 0.75); // Formule approx marche
        
        document.getElementById('cal-result').innerText = `${cals} kcal`;
        // Stockage temp pour save
        state.tour.finalCals = cals;
        state.tour.finalKm = km;
    };

    window.saveTourData = async () => {
        const qty = document.getElementById('flyer-input').value || 0;
        
        await supabaseClient.from('tours').insert({
            negociateur: state.nego,
            duration: document.getElementById('chrono').innerText,
            flyers_count: qty,
            distance_km: state.tour.finalKm.toFixed(2),
            calories: state.tour.finalCals
        });
        
        alert("Tourn√©e enregistr√©e. Repos bien m√©rit√© !");
        location.reload(); // Reset complet
    };

    // Gestion GPS (Tracking Distance)
    function activateGPS() {
        if(!navigator.geolocation) return;
        document.getElementById('btn-gps').classList.add('gps-on');
        
        state.gpsWatch = navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const ll = [lat, lng];

            // Update Marker
            if(!state.userMarker) {
                state.userMarker = L.circleMarker(ll, {radius: 8, color: 'white', fillColor: '#007AFF', fillOpacity: 1}).addTo(map);
                map.setView(ll, 17);
            } else {
                state.userMarker.setLatLng(ll);
            }

            // Calcul Distance si Tourn√©e Active
            if(state.tour.active && !state.tour.paused && state.tour.lastPos) {
                const dist = turf.distance(
                    turf.point(state.tour.lastPos), 
                    turf.point([lng, lat]), 
                    {units: 'kilometers'}
                );
                // Filtre bruit GPS (ne compte pas les sauts < 2m ou > 100m en 1s)
                if(dist > 0.002 && dist < 0.1) {
                    state.tour.distance += dist;
                }
            }
            state.tour.lastPos = [lng, lat];

        }, err => console.error(err), { enableHighAccuracy: true });
    }

    window.centerGPS = () => {
        if(state.gpsWatch) {
            // D√©j√† actif, on coupe
            navigator.geolocation.clearWatch(state.gpsWatch);
            state.gpsWatch = null;
            document.getElementById('btn-gps').classList.remove('gps-on');
        } else {
            activateGPS();
        }
    };

    // --- 5. UTILS & INIT ---

    window.toggleSat = () => {
        state.satMode = !state.satMode;
        if(state.satMode) { map.removeLayer(layerPlan); map.addLayer(layerSat); document.body.classList.add('dark'); }
        else { map.removeLayer(layerSat); map.addLayer(layerPlan); document.body.classList.remove('dark'); }
    };

    window.toggleTheme = () => document.body.classList.toggle('dark');

    // Changement N√©gociateur = Centrage Zone
    document.getElementById('user-pick').addEventListener('change', (e) => {
        state.nego = e.target.value;
        document.getElementById('user-icon').innerText = EMOJIS[state.nego];
        
        // FlyTo Zone
        const target = USERS[state.nego].center;
        if(target) map.setView(target, 15, { animate: true, duration: 1.5 });
    });

    // Chargement Donn√©es
    async function init() {
        // Load DB
        const { data } = await supabaseClient.from('street_passages').select('*');
        let hist = {}; if(data) data.forEach(d => hist[d.street_name] = d);

        // Load OSM (Toutes les rues)
        const query = `[out:json][timeout:25]; way["highway"~"residential|unclassified|living_street|tertiary|secondary|service|track"](44.96,-0.50,45.04,-0.40); out geom;`;
        
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
            const json = await res.json();
            json.elements.forEach(el => {
                if(el.tags && el.tags.name) {
                    drawStreet(el.tags.name, el.geometry.map(p=>[p.lat,p.lon]), hist[el.tags.name]);
                }
            });
        } catch(e) { console.error("Erreur OSM", e); }
    }

    init();
  </script>
</body>
</html>
