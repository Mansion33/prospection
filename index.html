<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mansion - Secteurs Organiques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    /* --- DESIGN √âPUR√â --- */
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8f9fa; overflow: hidden; }
    
    /* En-t√™te */
    header { background: #fff; height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; z-index: 1000; position: relative; }
    .brand { font-weight: 800; font-size: 16px; color: #333; }
    .controls { display: flex; gap: 8px; }
    
    select, button { height: 36px; padding: 0 12px; border-radius: 8px; border: 1px solid #ccc; background: white; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    button:active { transform: scale(0.98); }
    button.primary { background: #111; color: white; border: none; font-weight: 600; }
    button.accent { background: #007AFF; color: white; border: none; }
    button.warning { background: #FF9500; color: white; border: none; }

    /* Tableau de bord */
    #dashboard { background: rgba(255,255,255,0.95); padding: 12px; position: absolute; top: 60px; left: 0; right: 0; z-index: 900; backdrop-filter: blur(5px); border-bottom: 1px solid #eee; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    
    .stats-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #666; font-weight: 500; }
    .stats-bar strong { color: #000; font-size: 14px; }
    
    .action-row { display: flex; gap: 8px; }
    .input-wrapper { flex: 1; display: flex; flex-direction: column; }
    .input-wrapper input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }

    /* Carte */
    #map { width: 100%; height: calc(100vh - 60px); z-index: 1; margin-top: 0px; }

    /* Popup */
    .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; }
    .leaflet-popup-content { margin: 15px; text-align: center; line-height: 1.5; }
    .popup-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; display: block; }
    .popup-zone { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: block; }
    .btn-validate { background: #34C759; color: white; border: none; width: 100%; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 8px; }

    /* Labels sur la carte */
    .zone-label { background: transparent; border: none; box-shadow: none; font-weight: bold; font-size: 10px; text-align: center; text-shadow: 0 0 3px white; opacity: 0.7; }
  </style>
</head>
<body>

  <header>
    <div class="brand">MANSION</div>
    <div class="controls">
      <select id="negociateur">
        <option value="Alexis">Alexis (Nord-Ouest)</option>
        <option value="Nicolas">Nicolas (Nord-Est)</option>
        <option value="Thibault">Thibault (Sud-Ouest)</option>
        <option value="Laurent">Laurent (Sud-Est)</option>
      </select>
      <button id="btnGps" class="accent">üìç GPS</button>
      <button id="btnLoad">‚¨áÔ∏è Charger</button>
    </div>
  </header>

  <div id="dashboard">
    <div class="stats-bar">
      <span>‚è± <span id="timer">00:00:00</span></span>
      <span>Couverture : <strong id="coverage">0%</strong></span>
    </div>
    <div class="action-row">
      <button id="btnStart" class="primary" style="flex:1;">‚ñ∂ D√©marrer</button>
      <button id="btnPause" class="warning" style="display:none; flex:1;">‚è∏ Pause</button>
      <button id="btnStop" style="background:#eee; color:#999; width:40px;" disabled>üíæ</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- 1. CONFIGURATION & ZONES ORGANIQUES ---
    
    // Centre approximatif de Saint-Andr√© (√âglise/Mairie) : 44.9945, -0.4465
    // On dessine des polygones qui partent du centre vers l'ext√©rieur
    const CENTER = [44.9945, -0.4465];
    
    const ZONES = [
      { 
        id: 1, nego: "Alexis", color: "#e74c3c", // ROUGE (Nord-Ouest : vers Cubzac-les-Ponts)
        poly: [CENTER, [44.996, -0.448], [45.02, -0.46], [45.02, -0.49], [44.99, -0.49], [44.994, -0.45]] 
      },
      { 
        id: 2, nego: "Nicolas", color: "#3498db", // BLEU (Nord-Est : vers Val de Virv√©e)
        poly: [CENTER, [44.996, -0.445], [45.02, -0.44], [45.02, -0.40], [44.995, -0.40], [44.9945, -0.44]] 
      },
      { 
        id: 3, nego: "Thibault", color: "#f1c40f", // JAUNE (Sud-Ouest : vers la Dordogne)
        poly: [CENTER, [44.994, -0.45], [44.99, -0.49], [44.95, -0.49], [44.95, -0.446], [44.993, -0.446]] 
      },
      { 
        id: 4, nego: "Laurent", color: "#9b59b6", // VIOLET (Sud-Est : vers Libourne)
        poly: [CENTER, [44.993, -0.446], [44.95, -0.446], [44.95, -0.40], [44.995, -0.40], [44.995, -0.445]] 
      }
    ];

    // Rues en cache pour d√©marrage imm√©diat
    const STATIC_STREETS = [
      {name:"Rue Nationale", pts:[[44.993,-0.445],[44.998,-0.446],[45.005,-0.447]]},
      {name:"Route de Libourne", pts:[[44.993,-0.445],[44.990,-0.440],[44.985,-0.430]]},
      {name:"Rue de la Gare", pts:[[44.995,-0.446],[44.996,-0.450],[44.997,-0.455]]},
      {name:"Avenue de l'Europe", pts:[[45.000,-0.440],[45.005,-0.435]]},
      {name:"Rue du Commandant Cousteau", pts:[[44.998,-0.442],[45.000,-0.438]]},
      {name:"Rue Dantagnan", pts:[[44.994,-0.448],[44.994,-0.452]]},
      {name:"Chemin du Bois Milon", pts:[[44.985,-0.445],[44.980,-0.445]]},
      {name:"Rue de la Fontaine", pts:[[44.992,-0.448],[44.990,-0.450]]}
    ];

    const map = L.map('map', { zoomControl: false }).setView(CENTER, 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
    
    // √âtat global
    let state = { nego: "Alexis", streets: {}, status: "stopped", startT: 0, elapsed: 0, interval: null, gps: null, marker: null };
    let supabaseClient = null;

    // --- 2. INITIALISATION & DESSIN ---

    function init() {
        // A. Connexion Supabase (Silencieuse)
        try {
            const SUPA_URL = "https://wqujtckrvdhrwknplumq.supabase.co"; 
            const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
            if(typeof supabase !== 'undefined') supabaseClient = supabase.createClient(SUPA_URL, SUPA_KEY);
        } catch(e) {}

        // B. Dessin des Zones (INTERACTIVE FALSE est CRUCIAL pour le clic des rues)
        ZONES.forEach(z => {
            const polyPts = z.poly.map(p => [p[0], p[1]]); // Leaflet attend Lat,Lng
            
            // Polygone de zone
            L.polygon(polyPts, { 
                color: z.color, 
                fillOpacity: 0.08, 
                weight: 1, 
                dashArray: '5,5',
                interactive: false // <--- C'est ICI le secret pour que les rues dessous soient cliquables
            }).addTo(map);

            // Label
            // Calcul du centre approximatif pour le label
            const latSum = polyPts.reduce((sum, p) => sum + p[0], 0) / polyPts.length;
            const lngSum = polyPts.reduce((sum, p) => sum + p[1], 0) / polyPts.length;
            
            L.marker([latSum, lngSum], {
                icon: L.divIcon({
                    className: 'zone-label',
                    html: `<div style="color:${z.color}">${z.nego.toUpperCase()}</div>`,
                    iconSize: [100, 20]
                }),
                interactive: false
            }).addTo(map);
        });

        // C. Chargement des donn√©es
        loadStreets();
    }

    async function loadStreets() {
        // 1. R√©cup√©rer historique
        let history = {};
        if(supabaseClient) {
            const { data } = await supabaseClient.from('street_passages').select('*');
            if(data) data.forEach(d => history[d.street_name] = d.passage_date);
        }

        // 2. Rues Statiques (Imm√©diat)
        STATIC_STREETS.forEach(s => drawStreet(s.name, s.pts, history[s.name]));
        
        updateUI();
    }

    function drawStreet(name, pts, lastDate) {
        if(state.streets[name]) return; // D√©j√† l√†

        // Trouver la zone ID (Turf)
        let zoneId = null;
        try {
            const center = pts[Math.floor(pts.length/2)];
            const pt = turf.point([center[1], center[0]]); // Lon, Lat
            const found = ZONES.find(z => {
                // Turf a besoin de polygones ferm√©s [lon, lat]
                const turfPolyCoords = z.poly.map(p => [p[1], p[0]]); 
                // Fermeture du polygone si n√©cessaire
                if (turfPolyCoords[0][0] !== turfPolyCoords[turfPolyCoords.length-1][0]) {
                   turfPolyCoords.push(turfPolyCoords[0]);
                }
                return turf.booleanPointInPolygon(pt, turf.polygon([turfPolyCoords]));
            });
            if(found) zoneId = found.id;
        } catch(e) { console.log(e); }

        // Couleur
        let color = "#bdc3c7"; // Gris
        if(lastDate) {
             const days = (new Date() - new Date(lastDate)) / (8.64e7);
             if(days <= 20) color = "#2ecc71"; // Vert
             else if(days <= 45) color = "#f39c12"; // Orange
             else color = "#e74c3c"; // Rouge
        }

        // 1. Ligne de CLIC (Large, invisible, au-dessus)
        const hitLine = L.polyline(pts, { weight: 22, opacity: 0 }).addTo(map);
        
        // Gestionnaire de Clic avec ZOOM
        hitLine.on('click', (e) => {
             const safeName = name.replace(/'/g, "\\'");
             
             // ZOOM : On centre sur la rue avec une petite marge
             map.flyToBounds(e.target.getBounds(), { padding: [50, 250], maxZoom: 18, duration: 0.5 });

             L.popup({ offset: [0, -10] })
               .setLatLng(e.latlng)
               .setContent(`
                 <span class="popup-title">${name}</span>
                 <span class="popup-zone">Secteur ${zoneId ? zoneId : "Hors Zone"}</span>
                 Passage : <strong>${lastDate ? new Date(lastDate).toLocaleDateString() : "Jamais"}</strong><br>
                 <button class="btn-validate" onclick="markDone('${safeName}', ${zoneId})">‚úÖ MARQUER FAIT</button>
               `)
               .openOn(map);
        });

        // 2. Ligne VISUELLE (Fine, non-interactive)
        const visLine = L.polyline(pts, { color: color, weight: 4, opacity: 0.9, interactive: false }).addTo(map);

        state.streets[name] = { hitLine, visLine, zoneId, date: lastDate };
    }

    // Validation
    window.markDone = async (name, zoneId) => {
        const today = new Date().toISOString().split('T')[0];
        if(state.streets[name]) {
            state.streets[name].visLine.setStyle({ color: '#2ecc71' }); // Vert imm√©diat
            state.streets[name].date = today;
        }
        map.closePopup();
        updateUI();

        if(supabaseClient) {
            await supabaseClient.from('street_passages').upsert({
                street_name: name, passage_date: today, negociateur: state.nego, zone_id: zoneId
            }, { onConflict: 'street_name' });
        }
    }

    // --- 3. LOGIQUE INTERFACE & TIMER ---

    function updateUI() {
        // Filtrage visuel selon le N√©gociateur s√©lectionn√©
        const myZoneId = ZONES.find(z => z.nego === state.nego)?.id;
        
        let done = 0, total = 0;

        Object.values(state.streets).forEach(st => {
            const isMine = (st.zoneId === myZoneId);
            
            // Rues du secteur : Opaques et √©paisses
            // Rues hors secteur : Tr√®s transparentes et fines
            st.visLine.setStyle({ 
                opacity: isMine ? 1 : 0.15, 
                weight: isMine ? 4 : 2 
            });
            
            // Mise au premier plan des lignes de clic actives
            if(isMine) {
                st.hitLine.bringToFront(); // S'assure que le clic marche
                total++;
                if(st.date && (new Date() - new Date(st.date))/(8.64e7) <= 20) done++;
            }
        });

        const pct = total ? Math.round((done/total)*100) : 0;
        document.getElementById('coverage').innerText = `${pct}%`;
    }

    // Gestion Timer (Start / Pause / Stop)
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnStop = document.getElementById('btnStop');

    function formatTime(sec) {
        return new Date(sec * 1000).toISOString().substr(11, 8);
    }

    btnStart.addEventListener('click', () => {
        state.status = "running";
        state.startT = Date.now() - state.elapsed;
        state.interval = setInterval(() => {
            state.elapsed = Date.now() - state.startT;
            document.getElementById('timer').innerText = formatTime(Math.floor(state.elapsed/1000));
        }, 1000);
        
        btnStart.style.display = 'none';
        btnPause.style.display = 'inline-block';
        btnPause.innerText = "‚è∏ Pause";
        btnStop.disabled = false; btnStop.style.background = "#ff3b30"; btnStop.style.color="white";
    });

    btnPause.addEventListener('click', () => {
        if(state.status === "running") {
            // Mettre en Pause
            state.status = "paused";
            clearInterval(state.interval);
            btnPause.innerText = "‚ñ∂ Reprendre";
            btnPause.classList.remove('warning'); btnPause.classList.add('accent');
        } else {
            // Reprendre
            state.status = "running";
            state.startT = Date.now() - state.elapsed;
            state.interval = setInterval(() => {
                state.elapsed = Date.now() - state.startT;
                document.getElementById('timer').innerText = formatTime(Math.floor(state.elapsed/1000));
            }, 1000);
            btnPause.innerText = "‚è∏ Pause";
            btnPause.classList.remove('accent'); btnPause.classList.add('warning');
        }
    });

    btnStop.addEventListener('click', async () => {
        clearInterval(state.interval);
        if(confirm("Terminer et sauvegarder la tourn√©e ?")) {
            if(supabaseClient) {
                await supabaseClient.from('tours').insert({
                    negociateur: state.nego,
                    date: new Date().toISOString().split('T')[0],
                    duration_sec: Math.floor(state.elapsed/1000),
                    report: "Fin de tourn√©e"
                });
            }
            location.reload();
        }
    });

    // Autres Listeners
    document.getElementById('negociateur').addEventListener('change', (e) => {
        state.nego = e.target.value;
        updateUI();
    });

    document.getElementById('btnLoad').addEventListener('click', async () => {
        const btn = document.getElementById('btnLoad');
        btn.innerText = "‚è≥...";
        try {
            // Overpass sur St Andr√©
            const q = `[out:json][timeout:15];way["highway"~"residential|unclassified|living_street"](44.97,-0.48,45.02,-0.41);out geom;`;
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q));
            const data = await res.json();
            
            let count = 0;
            data.elements.forEach(el => {
                if(el.tags && el.tags.name) {
                    const pts = el.geometry.map(p => [p.lat, p.lon]);
                    if(!state.streets[el.tags.name]) {
                        drawStreet(el.tags.name, pts, null);
                        count++;
                    }
                }
            });
            alert(`${count} rues charg√©es !`);
            updateUI();
        } catch(e) { alert("Erreur chargement :("); }
        btn.innerText = "‚¨áÔ∏è Charger";
    });
    
    document.getElementById('btnGps').addEventListener('click', () => {
        if(state.gps) {
            navigator.geolocation.clearWatch(state.gps); state.gps=null;
            if(state.marker) map.removeLayer(state.marker);
        } else {
            state.gps = navigator.geolocation.watchPosition(pos => {
                const ll = [pos.coords.latitude, pos.coords.longitude];
                if(!state.marker) state.marker = L.circleMarker(ll, {radius:8, color:'white', fillColor:'#007AFF', fillOpacity:1}).addTo(map);
                else state.marker.setLatLng(ll);
                // On ne force pas le setView pour ne pas g√™ner la navigation manuelle
            }, null, { enableHighAccuracy:true });
        }
    });

    // START
    init();

  </script>
</body>
</html>
