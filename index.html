<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte de Prospection - Mansion Bordeaux</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    /* --- STYLES IDENTIQUES --- */
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; color: #333; overflow: hidden; }
    * { box-sizing: border-box; }
    header { background: #fff; padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; z-index: 1000; position: relative; }
    .brand { font-weight: 700; font-size: 15px; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    select, button { font-size: 13px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #000; color: #fff; border: 1px solid #000; }
    button.accent { background: #0066cc; color: #fff; border: none; }
    
    #dashboard { background: #fff; border-bottom: 1px solid #ddd; padding: 10px 15px; max-height: 30vh; overflow-y: auto; font-size: 13px; display: flex; flex-direction: column; gap: 8px; }
    .stats-row { display: flex; gap: 15px; flex-wrap: wrap; color: #555; font-size: 12px; align-items: center; }
    .tour-panel { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
    .input-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 120px; }
    .input-group input, .input-group textarea { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
    
    #map { width: 100%; height: calc(100vh - 180px); background: #e5e5e5; }
    
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; transition: opacity 0.5s; pointer-events: none; opacity: 0; }
    #loadingOverlay.active { opacity: 1; pointer-events: all; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .leaflet-popup-content { font-size: 13px; line-height: 1.4; text-align: center; }
    .popup-btn { width: 100%; margin-top: 8px; padding: 8px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="active">
    <div class="spinner"></div>
    <div id="loadingText">D√©marrage...</div>
  </div>

  <header>
    <div class="brand">Mansion Bordeaux</div>
    <div class="controls">
      <select id="negociateurSelect">
        <option value="Alexis">Alexis (Nord-Ouest)</option>
        <option value="Nicolas">Nicolas (Nord-Est)</option>
        <option value="Thibault">Thibault (Sud-Ouest)</option>
        <option value="Laurent">Laurent (Sud-Est)</option>
      </select>
      <button id="gpsBtn" class="accent">üìç GPS</button>
      <button id="loadMoreBtn" title="T√©l√©charger plus de rues">‚¨áÔ∏è Charger +</button>
    </div>
  </header>

  <div id="dashboard">
    <div class="stats-row">
      <span class="stat-item">Tourn√©e : <strong id="timerDisplay">00:00:00</strong></span>
      <span class="stat-item">Couverture : <strong id="coverageDisplay">--%</strong></span>
      <span id="statusMessage" style="color:green; font-weight:bold;"></span>
    </div>

    <div class="tour-panel">
      <div class="input-group"><label>Flyers</label><input type="number" id="flyersInput" placeholder="Qt√©" /></div>
      <div class="input-group" style="flex: 2;"><label>Notes</label><input id="reportInput" placeholder="R.A.S..." /></div>
      <div style="display:flex; gap:5px; margin-top: auto;">
        <button id="toggleTourBtn" class="primary">‚ñ∂ Go</button>
        <button id="saveTourBtn" style="background:#eee;" disabled>üíæ Fin</button>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    /* --- CONFIG --- */
    const SUPABASE_URL = "https://wqujtckrvdhrwknplumq.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdWp0Y2tydmRocndrbnBsdW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjcwOTQsImV4cCI6MjA3ODcwMzA5NH0.btJD5-yD_zRJ9niEvwYEF46iB18OJo8nNXHRTbc8opE";
    
    // Secteurs St-Andr√©-de-Cubzac ajust√©s
    const ZONES = [
      { id: 1, negociateur: "Alexis", color: "#e74c3c", poly: [[-0.446, 45.02], [-0.48, 45.02], [-0.48, 44.995], [-0.446, 44.995]] },
      { id: 2, negociateur: "Nicolas", color: "#3498db", poly: [[-0.41, 45.02], [-0.446, 45.02], [-0.446, 44.995], [-0.41, 44.995]] },
      { id: 3, negociateur: "Thibault", color: "#f1c40f", poly: [[-0.446, 44.995], [-0.48, 44.995], [-0.48, 44.96], [-0.446, 44.96]] },
      { id: 4, negociateur: "Laurent", color: "#9b59b6", poly: [[-0.41, 44.995], [-0.446, 44.995], [-0.446, 44.96], [-0.41, 44.96]] }
    ];

    // RUES PR√â-CHARG√âES (St Andr√©) pour √©viter le chargement infini
    const PRELOADED_STREETS = [
      { name: "Rue Nationale", coords: [[44.993, -0.445], [44.998, -0.446], [45.002, -0.447]] },
      { name: "Route de Libourne", coords: [[44.993, -0.445], [44.990, -0.440], [44.985, -0.430]] },
      { name: "Rue de la Gare", coords: [[44.995, -0.446], [44.996, -0.450], [44.997, -0.455]] },
      { name: "Avenue de l'Europe", coords: [[45.000, -0.440], [45.005, -0.435]] },
      { name: "Chemin du Bois Milon", coords: [[44.985, -0.445], [44.980, -0.445]] },
      { name: "Route de Saint-Romain", coords: [[44.990, -0.450], [44.985, -0.460]] },
      { name: "Rue Commandant Cousteau", coords: [[44.998, -0.442], [45.000, -0.438]] },
      { name: "Rue Dantagnan", coords: [[44.994, -0.448], [44.994, -0.452]] },
      { name: "Impasse des Vignes", coords: [[44.988, -0.435], [44.986, -0.432]] },
      { name: "All√©e des Platanes", coords: [[45.001, -0.450], [45.003, -0.455]] }
    ];

    let supabaseClient = null;
    if (typeof supabase !== "undefined") supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = { negociateur: "Alexis", streets: {}, tourRunning: false, startTime: null, timer: null, gpsWatch: null, userMarker: null };
    
    const map = L.map('map', { zoomControl: false }).setView([44.995, -0.446], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', maxZoom: 19 }).addTo(map);

    // --- FONCTIONS ---

    async function initApp() {
      // 1. Charger Historique Supabase
      let historyMap = {};
      if (supabaseClient) {
        const { data } = await supabaseClient.from('street_passages').select('*');
        if (data) data.forEach(r => historyMap[r.street_name] = r);
      }

      // 2. Afficher les rues pr√©-charg√©es (Imm√©diat)
      PRELOADED_STREETS.forEach(s => addStreetToMap(s.name, s.coords, historyMap));
      
      // 3. Afficher les zones
      ZONES.forEach(z => {
        L.polygon(z.poly.map(p => [p[1], p[0]]), { color: z.color, fillOpacity: 0.05, weight: 1, dashArray: '4,4', interactive: false }).addTo(map);
      });

      updateInterface();
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    function addStreetToMap(name, coords, historyMap = {}) {
      if (state.streets[name]) return; // √âvite doublons

      // Trouver la zone
      const center = coords[Math.floor(coords.length/2)];
      const pt = turf.point([center[1], center[0]]);
      let zoneId = null;
      for (let z of ZONES) {
        if (turf.booleanPointInPolygon(pt, turf.polygon([z.poly]))) { zoneId = z.id; break; }
      }

      const hist = historyMap[name] || {};
      const color = getStreetColor(hist.passage_date);

      // Couche CLIC (Invisible large)
      L.polyline(coords, { weight: 25, opacity: 0 }).addTo(map)
        .on('click', (e) => openPopup(e, name, zoneId, hist));

      // Couche VISIBLE (Fine)
      const layer = L.polyline(coords, { color: color, weight: 3, opacity: 0.9, interactive: false }).addTo(map);

      state.streets[name] = { layer, zoneId, lastPassage: hist.passage_date, lastNego: hist.negociateur };
    }

    function getStreetColor(date) {
      if (!date) return "#bdc3c7"; // Gris
      const diff = (new Date() - new Date(date)) / (1000 * 3600 * 24);
      if (diff <= 20) return "#2ecc71"; // Vert
      if (diff <= 45) return "#f39c12"; // Orange
      return "#e74c3c"; // Rouge
    }

    function openPopup(e, name, zoneId, hist) {
      const date = state.streets[name].lastPassage ? new Date(state.streets[name].lastPassage).toLocaleDateString() : "Jamais";
      const safeName = name.replace(/'/g, "\\'");
      
      L.popup().setLatLng(e.latlng).setContent(`
        <div style="text-align:center">
          <strong>${name}</strong><br>
          <small>Zone ${zoneId || "?"}</small><hr style="margin:5px 0">
          Passage: <b>${date}</b><br>
          <button class="popup-btn" onclick="markDone('${safeName}')">‚úÖ FAIT</button>
        </div>
      `).openOn(map);
    }

    window.markDone = async function(name) {
      const today = new Date().toISOString().split('T')[0];
      const st = state.streets[name];
      if(st) {
        st.layer.setStyle({ color: '#2ecc71' });
        st.lastPassage = today;
        st.lastNego = state.negociateur;
        updateInterface();
      }
      map.closePopup();
      if(supabaseClient) {
        await supabaseClient.from('street_passages').upsert({ street_name: name, passage_date: today, negociateur: state.negociateur, zone_id: st.zoneId }, { onConflict: 'street_name' });
      }
    }

    function updateInterface() {
      const myZone = ZONES.find(z => z.negociateur === state.negociateur)?.id;
      Object.values(state.streets).forEach(st => {
        if (st.zoneId === myZone) st.layer.setStyle({ opacity: 1, weight: 4, dashArray: null });
        else st.layer.setStyle({ opacity: 0.3, weight: 2, dashArray: '4,4' });
      });
      
      // Coverage
      const streetsInZone = Object.values(state.streets).filter(s => s.zoneId === myZone);
      if(!streetsInZone.length) return document.getElementById('coverageDisplay').innerText = "N/A";
      const done = streetsInZone.filter(s => s.lastPassage && (new Date() - new Date(s.lastPassage))/(1e8*8.64) <= 20).length;
      const pct = Math.round((done/streetsInZone.length)*100);
      document.getElementById('coverageDisplay').innerText = `${pct}% (${done}/${streetsInZone.length})`;
    }

    // --- CHARGEMENT DYNAMIQUE OPTIONNEL ---
    document.getElementById('loadMoreBtn').addEventListener('click', async () => {
        const btn = document.getElementById('loadMoreBtn');
        btn.innerText = "‚è≥...";
        try {
            // Requ√™te Overpass St Andr√© Large
            const q = `[out:json][timeout:15];(way["highway"~"residential|unclassified"](44.97,-0.48,45.02,-0.41););out geom;`;
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q));
            const data = await res.json();
            
            let count = 0;
            data.elements.forEach(el => {
                if (el.tags && el.tags.name) {
                    const coords = el.geometry.map(p => [p.lat, p.lon]);
                    addStreetToMap(el.tags.name, coords);
                    count++;
                }
            });
            alert(`${count} rues ajout√©es !`);
            updateInterface();
        } catch (e) {
            alert("Erreur t√©l√©chargement (API trop charg√©e). R√©essayez plus tard.");
        }
        btn.innerText = "‚¨áÔ∏è Charger +";
    });

    // --- LISTENERS UI ---
    document.getElementById('negociateurSelect').addEventListener('change', (e) => { state.negociateur = e.target.value; updateInterface(); });
    
    document.getElementById('toggleTourBtn').addEventListener('click', function() {
        state.tourRunning = !state.tourRunning;
        this.innerText = state.tourRunning ? "‚è∏ Pause" : "‚ñ∂ Go";
        this.className = state.tourRunning ? "accent" : "primary";
        document.getElementById('saveTourBtn').disabled = !state.tourRunning && !state.startTime;
        
        if(state.tourRunning) {
            if(!state.startTime) state.startTime = Date.now();
            state.timer = setInterval(() => {
                const d = Math.floor((Date.now() - state.startTime)/1000);
                document.getElementById('timerDisplay').innerText = new Date(d*1000).toISOString().substr(11,8);
            }, 1000);
        } else clearInterval(state.timer);
    });

    document.getElementById('saveTourBtn').addEventListener('click', async () => {
        if(!supabaseClient) return alert("Hors ligne");
        const { error } = await supabaseClient.from('tours').insert({
            negociateur: state.negociateur, date: new Date().toISOString().split('T')[0],
            flyers: document.getElementById('flyersInput').value, report: document.getElementById('reportInput').value,
            duration_sec: Math.floor((Date.now()-state.startTime)/1000)
        });
        if(!error) { alert("Sauvegard√©"); location.reload(); }
    });

    document.getElementById('gpsBtn').addEventListener('click', function() {
        if(state.gpsWatch) {
            navigator.geolocation.clearWatch(state.gpsWatch); state.gpsWatch = null;
            if(state.userMarker) map.removeLayer(state.userMarker);
            this.innerText = "üìç GPS";
        } else {
            this.innerText = "üõë Stop";
            state.gpsWatch = navigator.geolocation.watchPosition(pos => {
                const latlng = [pos.coords.latitude, pos.coords.longitude];
                if(!state.userMarker) state.userMarker = L.circleMarker(latlng, { radius:8, color:'white', fillColor:'#007AFF', fillOpacity:1 }).addTo(map);
                else state.userMarker.setLatLng(latlng);
            }, null, {enableHighAccuracy:true});
        }
    });

    // START
    initApp();

  </script>
</body>
</html>
